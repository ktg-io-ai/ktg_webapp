<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KTG Admin Dashboard</title>
    <link rel="icon" type="image/png" href="../../public/assets/icons/kgz_icon.png"/>
    <link rel="stylesheet" href="../../shared/styles/global.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="../../shared/js/theme-icons.js"></script>
    <script src="../../shared/js/language.js"></script>
    <style>
        :root {
            --bg-primary: #111;
            --bg-secondary: #222;
            --text-primary: #fff;
            --text-secondary: #ccc;
            --accent-color: #2f27c8;
            --accent-hover: #4fb6c1;
            --border-color: #2f27c8;
            --hover-bg: #333;
        }

        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --text-primary: #1a1a1a;
            --text-secondary: #6c757d;
            --border-color: #e9ecef;
            --hover-bg: #f1f3f4;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2a2a2a;
            --text-primary: #f5f5dc;
            --text-secondary: #b8b8b8;
            --border-color: #404040;
            --hover-bg: #3a3a3a;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Top Bar */
        .top-bar {
            background-color: #111;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 33px;
            z-index: 999;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            box-sizing: border-box;
        }

        .top-bar h1 {
            margin: 0;
            font-size: 16px;
            color: var(--text-primary);
            flex-grow: 1;
        }

        .song-title {
            font-size: 16px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
        }

        #musicToggle {
            background: none;
            border: none;
            cursor: pointer;
            margin-right: 10px;
            padding: 5px;
        }

        #musicToggle img {
            width: 30px;
            height: 30px;
        }

        /* Second Bar */
        .second-bar {
            background-color: var(--bg-secondary);
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 33px;
            position: fixed;
            top: 50px;
            left: 0;
            width: 100%;
            box-sizing: border-box;
            z-index: 998;
        }

        .portal-button {
            background-color: transparent;
            color: var(--text-primary);
            border: none;
            padding: 0 8px 0 0;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .portal-button:hover {
            background-color: var(--accent-hover);
        }

        .portal-button img {
            max-width: 35px;
            max-height: 35px;
            margin-right: 5px;
        }

        /* Main Content */
        .main-content {
            display: flex;
            margin-top: 100px;
            height: calc(100vh - 100px);
        }

        /* Collapsible Sidebar */
        .sidebar {
            width: 270px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            transition: width 0.3s ease;
            overflow: hidden;
        }

        .sidebar.collapsed {
            width: 90px;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .admin-header-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .admin-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }

        .admin-info {
            flex: 1;
            min-width: 0;
        }

        .admin-role {
            font-size: 12px;
            color: var(--accent-color);
            font-weight: bold;
        }

        .admin-name {
            font-size: 14px;
            color: var(--text-primary);
            margin-top: 2px;
        }

        .collapse-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            padding: 5px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .collapse-btn:hover {
            background: var(--hover-bg);
        }

        .sidebar-content {
            padding: 20px 0;
        }

        .menu-section {
            margin-bottom: 30px;
        }

        .section-title {
            padding: 0 20px;
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s ease;
            text-decoration: none;
            color: var(--text-primary);
        }

        .menu-item:hover {
            background: var(--hover-bg);
        }

        .menu-item.active {
            background: var(--accent-color);
            color: white;
        }

        .menu-icon {
            width: 20px;
            height: 20px;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .menu-text {
            font-size: 14px;
            white-space: nowrap;
        }

        .sidebar.collapsed .menu-text,
        .sidebar.collapsed .section-title,
        .sidebar.collapsed .admin-info {
            display: none;
        }

        .sidebar.collapsed .collapse-btn {
            margin: 0;
        }

        .sidebar.collapsed .menu-item {
            justify-content: center;
            padding: 12px;
        }

        .sidebar.collapsed .menu-icon {
            margin-right: 0;
        }

        .sidebar.collapsed .admin-avatar {
            margin: 0 auto;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
            margin-top: 20px;
        }

        .users-table th {
            background: var(--accent-color);
            color: white;
            padding: 12px;
            text-align: left;
            font-size: 12px;
            font-weight: bold;
        }

        .users-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
        }

        .users-table tr:hover {
            background: var(--hover-bg);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            background: #28a745;
            color: white;
        }

        .stats-container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }

        .stat-box {
            flex: 1;
            background: var(--bg-secondary);
            border: 2px solid var(--accent-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .users-table tr {
            cursor: pointer;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: var(--bg-secondary);
            margin: 5% auto;
            padding: 20px;
            border: 2px solid var(--accent-color);
            border-radius: 12px;
            width: 80%;
            max-width: 500px;
            position: relative;
        }

        .modal-close {
            color: var(--text-secondary);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--accent-color);
        }

        .modal h3 {
            margin-top: 0;
            color: var(--accent-color);
        }

        .modal-field {
            margin: 15px 0;
        }

        .modal-field label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .modal-field span {
            color: var(--text-secondary);
        }

        /* Submenu Styles */
        .submenu-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            pointer-events: none;
        }

        .submenu {
            position: absolute;
            top: 110px;
            right: 33px;
            background-color: rgba(1, 1, 1, 0.9);
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.5);
            border: 5px solid #2f27c8;
            padding: 20px;
            border-radius: 20px;
            z-index: 1001;
            pointer-events: auto;
            display: none;
            width: min(480px, 90vw);
            max-width: 90vw;
        }

        [data-theme="light"] .submenu {
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #e9ecef;
        }

        [data-theme="dark"] .submenu {
            background-color: rgba(42, 42, 42, 0.9);
            border: 1px solid #404040;
        }

        .submenu h2 {
            margin-top: 0;
            color: var(--text-primary);
            text-align: center;
            margin-bottom: 16px;
        }

        .portal-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .portal-grid .portal-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            text-decoration: none;
            padding: min(16px, 2.4vw);
            border-radius: 12px;
            transition: all 0.3s ease;
            aspect-ratio: 1;
            border: 2px solid transparent;
            min-width: 0;
        }

        .portal-grid .portal-button:hover {
            background-color: var(--bg-secondary);
            border-color: #2f27c8;
            transform: scale(1.05);
        }

        .portal-grid .portal-button img {
            width: min(32px, 6.4vw);
            height: min(32px, 6.4vw);
            margin-bottom: min(8px, 1.6vw);
        }

        .portal-grid .portal-button span {
            font-size: min(10px, 2vw);
            text-align: center;
            font-weight: bold;
        }

        .close-button {
            float: right;
            cursor: pointer;
            margin-left: 10px;
        }

        .close-button:hover {
            color: red;
        }
        
        .journeybook-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .section-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .section-selector select {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .form-input {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            box-sizing: border-box;
        }
        
        .question-item {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .question-item h4 {
            margin: 0 0 10px 0;
            color: var(--accent-color);
        }
        
        .question-options {
            margin: 10px 0;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .question-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .btn-edit {
            background-color: var(--accent-color);
            color: white;
        }
        
        .btn-delete {
            background-color: #dc3545;
            color: white;
        }

        /* Avatar Grid Styles */
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px 0;
        }

        .avatar-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .avatar-card:hover {
            border-color: var(--accent-color);
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(47, 39, 200, 0.3);
        }

        .avatar-thumbnail {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 15px;
            background: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .avatar-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .avatar-name {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .avatar-tagline {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-style: italic;
        }

        .avatar-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            background: #28a745;
            color: white;
        }

        .loading-message {
            grid-column: 1 / -1;
            text-align: center;
            color: var(--text-secondary);
            padding: 40px;
        }

        @media (max-width: 768px) {
            .avatar-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }
            
            .avatar-card {
                padding: 15px;
            }
            
            .avatar-thumbnail {
                width: 60px;
                height: 60px;
                font-size: 18px;
            }
        }

        @media (max-width: 480px) {
            .avatar-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-bar">
            <h1>KTG Admin Dashboard</h1>
            <div class="song-title">
                <button id="musicToggle">
                    <img src="../../public/assets/icons/play_pause.png" alt="Music Toggle">
                </button>
                <span>PLAYING: (Original Soundtrack) Admin Console</span>
            </div>
        </div>
        
        <div class="second-bar">
            <div class="admin-header-info">
                <div class="admin-avatar">RA</div>
                <div class="admin-info">
                    <div class="admin-role">SUPER ADMIN</div>
                    <div class="admin-name">Rene Alquimist</div>
                </div>
            </div>
            <button class="portal-button" onclick="openSubmenu('portal')">
                <img src="../../public/assets/icons/portal_icon.png" alt="Portal" class="portal-icon">
            </button>
        </div>

        <div class="main-content">
            <!-- Collapsible Sidebar -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <button class="collapse-btn" onclick="toggleSidebar()">
                        <span id="collapseIcon">◀</span>
                    </button>
                </div>

                <div class="sidebar-content">
                    <!-- General Section -->
                    <div class="menu-section">
                        <div class="section-title">General</div>
                        <a href="#" class="menu-item active" onclick="showSection('dashboard')">
                            <img src="../../public/assets/icons/dashboard_icon.png" alt="Dashboard" class="menu-icon">
                            <span class="menu-text">Dashboard</span>
                        </a>
                    </div>

                    <!-- Management Section -->
                    <div class="menu-section">
                        <div class="section-title">Management</div>
                        <a href="#" class="menu-item" onclick="showSection('lucy-ai')">
                            <img src="../../public/assets/icons/ai_brain_logo_icon.png" alt="Lucy AI" class="menu-icon">
                            <span class="menu-text">Lucy AI</span>
                        </a>
                        <a href="#" class="menu-item" onclick="showSection('users')">
                            <img src="../../public/assets/icons/detail_icon.png" alt="Users" class="menu-icon">
                            <span class="menu-text">Users</span>
                        </a>
                        <a href="#" class="menu-item" onclick="showSection('creators')">
                            <img src="../../public/assets/icons/creators_icon.png" alt="Creators" class="menu-icon">
                            <span class="menu-text">Creators</span>
                        </a>
                        <a href="#" class="menu-item" onclick="showSection('listings')">
                            <img src="../../public/assets/icons/listing_icon.png" alt="Listings" class="menu-icon">
                            <span class="menu-text">Listings</span>
                        </a>
                        <a href="#" class="menu-item" onclick="showSection('journeybook')">
                            <img src="../../public/assets/icons/journeybook_icon.png" alt="JourneyBook" class="menu-icon">
                            <span class="menu-text">JourneyBook</span>
                        </a>
                        <a href="#" class="menu-item" onclick="showSection('truth')">
                            <img src="../../public/assets/icons/truth_icon.png" alt="Truth" class="menu-icon">
                            <span class="menu-text">Truth</span>
                        </a>
                        <a href="#" class="menu-item" onclick="showSection('avatars')">
                            <img src="../../public/assets/icons/game_icon.png" alt="Avatars" class="menu-icon">
                            <span class="menu-text">Avatars</span>
                        </a>
                        <a href="#" class="menu-item" onclick="showSection('emoji')">
                            <img src="../../public/assets/icons/emoji_icon.png" alt="Emoji" class="menu-icon">
                            <span class="menu-text">Emoji</span>
                        </a>
                        <a href="#" class="menu-item" onclick="showSection('levels')">
                            <img src="../../public/assets/icons/levels_icon.png" alt="Levels" class="menu-icon">
                            <span class="menu-text">Levels</span>
                        </a>
                        <a href="#" class="menu-item" onclick="showSection('wallet')">
                            <img src="../../public/assets/icons/wallet_icon.png" alt="Wallet Tokens" class="menu-icon">
                            <span class="menu-text">Wallet Tokens</span>
                        </a>
                        <a href="#" class="menu-item" onclick="showSection('location')">
                            <img src="../../public/assets/icons/location_icon.png" alt="Location" class="menu-icon">
                            <span class="menu-text">Location</span>
                        </a>
                        <a href="#" class="menu-item" onclick="showSection('settings')">
                            <img src="../../public/assets/icons/settings_icon.png" alt="Settings" class="menu-icon">
                            <span class="menu-text">Settings</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <div id="dashboard-section">
                    <h2>Dashboard Overview</h2>
                    <div style="display: flex; height: calc(100vh - 220px); gap: 20px; margin-bottom: 20px;">
                        <div style="flex: 1; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
                            <iframe src="leftconsole_admin.html" style="width: 100%; height: 100%; border: none;"></iframe>
                        </div>
                        <div style="flex: 1; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
                            <iframe src="rightconsole_admin.html" style="width: 100%; height: 100%; border: none;"></iframe>
                        </div>
                    </div>

                    <p>Welcome to the KTG Admin Dashboard. Use the sidebar to navigate between different management sections.</p>
                </div>

                <div id="users-section" style="display: none;">
                    <h2>User Management</h2>
                    <div style="margin-bottom: 20px;">
                        <button class="nav-button" onclick="clearAllTestUsers()" style="background-color: #dc3545;">Clear All Test Users</button>
                        <button class="nav-button" onclick="loadUsers()" style="margin-left: 10px;">Refresh Users</button>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: var(--bg-secondary); border-radius: 8px;">
                        <h4>Filter Options:</h4>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <label><input type="checkbox" id="filterDestiny"> Destiny</label>
                            <label><input type="checkbox" id="filterChess"> Chess</label>
                            <label><input type="checkbox" id="filterBling"> Bling</label>
                            <label><input type="checkbox" id="filterCreator"> Creator</label>
                            <label><input type="checkbox" id="filterLevel"> Level</label>
                            <label><input type="checkbox" id="filterDateJoined"> Date Joined</label>
                            <label><input type="checkbox" id="filterCreatorDate"> Creator Date</label>
                            <label><input type="checkbox" id="filterLastLevelUp"> Last Level Up</label>
                        </div>
                        <button class="nav-button" onclick="applyFilters()" style="margin-top: 10px;">Apply Filters</button>
                    </div>
                    
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th onclick="sortTable(0)" style="cursor: pointer;">Email ↕</th>
                                <th onclick="sortTable(1)" style="cursor: pointer;" id="destinyCol">Destiny ↕</th>
                                <th onclick="sortTable(2)" style="cursor: pointer;" id="chessCol">Chess ↕</th>
                                <th onclick="sortTable(3)" style="cursor: pointer;" id="blingCol">Bling ↕</th>
                                <th onclick="sortTable(4)" style="cursor: pointer;" id="creatorCol">Creator ↕</th>
                                <th onclick="sortTable(5)" style="cursor: pointer;" id="levelCol">Level ↕</th>
                                <th onclick="sortTable(6)" style="cursor: pointer;" id="dateJoinedCol">Date Joined ↕</th>
                                <th onclick="sortTable(7)" style="cursor: pointer;" id="creatorDateCol">Creator Date ↕</th>
                                <th onclick="sortTable(8)" style="cursor: pointer;" id="lastLevelUpCol">Last Level Up ↕</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr><td colspan="9">Loading users...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div id="avatars-section" style="display: none;">
                    <h2>Avatar Gallery</h2>
                    <div style="margin-bottom: 20px;">
                        <button class="nav-button" onclick="loadAvatarsFromDB()">Load from Database</button>
                        <label style="margin-left: 15px;"><input type="checkbox" id="groupByEmail" onchange="toggleGroupByEmail()"> Group by Email</label>
                        <label style="margin-left: 15px;"><input type="checkbox" id="newestFirst" checked onchange="toggleSortOrder()"> Newest First</label>
                    </div>
                    <div id="avatarGrid" class="avatar-grid">
                        <div class="loading-message">Loading avatars...</div>
                    </div>
                </div>

                <div id="truth-section" style="display: none;">
                    <h2>Truth Management</h2>
                    <p>Manage truth verification system.</p>
                </div>

                <div id="listings-section" style="display: none;">
                    <h2>Listings Management</h2>
                    <p>Manage lifestyle listings and outings.</p>
                </div>

                <div id="avatar-section" style="display: none;">
                    <h2>Avatar Management</h2>
                    <p>Manage user avatars and AI generation.</p>
                </div>

                <div id="emoji-section" style="display: none;">
                    <h2>Emoji Management</h2>
                    <p>Manage custom emojis and reactions.</p>
                </div>

                <div id="media-section" style="display: none;">
                    <h2>Media Management</h2>
                    <p>Manage uploaded media and assets.</p>
                </div>

                <div id="levels-section" style="display: none;">
                    <h2>Levels Management</h2>
                    <p>Manage user levels and progression.</p>
                </div>

                <div id="wallet-section" style="display: none;">
                    <h2>Wallet Tokens Management</h2>
                    
                    <div style="background: var(--bg-secondary); border: 2px solid var(--accent-color); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h3>Game Master Token Distribution</h3>
                        <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                            <div>
                                <label>Target Email:</label><br>
                                <input type="email" id="tokenTargetEmail" class="form-input" placeholder="user@example.com" style="width: 250px;">
                            </div>
                            <div>
                                <label>1-Life Tokens:</label><br>
                                <input type="number" id="tokens1Life" class="form-input" value="10" min="0" style="width: 80px;">
                            </div>
                            <div>
                                <label>3-Life Tokens:</label><br>
                                <input type="number" id="tokens3Life" class="form-input" value="5" min="0" style="width: 80px;">
                            </div>
                            <div>
                                <label>6-Life Tokens:</label><br>
                                <input type="number" id="tokens6Life" class="form-input" value="2" min="0" style="width: 80px;">
                            </div>
                            <div>
                                <label>9-Life Tokens:</label><br>
                                <input type="number" id="tokens9Life" class="form-input" value="1" min="0" style="width: 80px;">
                            </div>
                            <div>
                                <label>Diamond Tokens:</label><br>
                                <input type="number" id="tokensDiamond" class="form-input" value="0" min="0" style="width: 80px;">
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="nav-button" onclick="distributeTokensToUser()">Distribute Tokens</button>
                            <button class="nav-button" onclick="distributeToAllTestUsers()" style="background-color: #28a745;">Distribute to All Test Users</button>
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px;">
                        <h3>Bulk Token Operations</h3>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <button class="nav-button" onclick="viewAllWallets()">View All Wallets</button>
                            <button class="nav-button" onclick="resetAllWallets()" style="background-color: #dc3545;">Reset All Wallets</button>
                        </div>
                        <div id="walletsList" style="margin-top: 20px;">
                            <!-- Wallet data will be displayed here -->
                        </div>
                    </div>
                </div>

                <div id="location-section" style="display: none;">
                    <h2>Location Management</h2>
                    <p>Manage geographic locations and regions.</p>
                </div>

                <div id="journeybook-section" style="display: none;">
                    <h2>JourneyBook Management</h2>
                    <div class="journeybook-controls">
                        <button class="nav-button" onclick="showQuestionManager()">Manage Questions</button>
                        <button class="nav-button" onclick="showImageGenerator()">Generate Images</button>
                        <button class="nav-button" onclick="showGeneratedImages()">View Generated Images</button>
                        <button class="nav-button" onclick="showAnswerAnalytics()">View Analytics</button>
                        <button class="nav-button" onclick="exportQuestions()">Export Questions</button>
                        <button class="nav-button" onclick="pushImagesToDatabase()" style="background-color: #28a745;">Push Images to Database</button>
                    </div>
                    
                    <div id="question-manager" style="display: none;">
                        <h3>Question Manager</h3>
                        <div class="section-selector">
                            <select id="sectionSelect" onchange="loadSectionQuestions()">
                                <option value="">Select Section</option>
                                <option value="values">Values</option>
                                <option value="compatibility">Compatibility</option>
                                <option value="intimacy">Intimacy</option>
                            </select>
                            <select id="subgroupSelect" onchange="loadSubgroupQuestions()">
                                <option value="">Select Subgroup</option>
                            </select>
                            <button class="nav-button" onclick="generateAndSaveAllImages()" style="margin-left: 10px;">Generate & Save All Images</button>
                        </div>
                        
                        <div id="questions-list">
                            <!-- Questions will be loaded here -->
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <button class="nav-button" onclick="loadGeneratedImages()">Load Generated Images</button>
                            <button class="nav-button" onclick="generateAndSaveAllImagesForSection()" style="margin-left: 10px; background-color: #28a745;">Generate & Save All Section Images</button>
                            <div id="generated-images-list" style="margin-top: 10px;">
                                <!-- Generated images will be shown here -->
                            </div>
                        </div>
                        
                        <div class="add-question-form" style="margin-top: 20px;">
                            <h4>Add New Question</h4>
                            <input type="text" id="newQuestion" placeholder="Question text" class="form-input">
                            <input type="text" id="newOptions" placeholder="Options (comma separated)" class="form-input">
                            <input type="text" id="newImage" placeholder="Image URL" class="form-input">
                            <button class="nav-button" onclick="addQuestion()">Add Question</button>
                        </div>
                    </div>
                    
                    <div id="image-generator" style="display: none;">
                        <h3>AI Image Generator</h3>
                        <div class="section-selector">
                            <select id="imageGenSection" onchange="loadImageGenSubgroups()">
                                <option value="">Select Section</option>
                                <option value="values">Values</option>
                                <option value="compatibility">Compatibility</option>
                                <option value="intimacy">Intimacy</option>
                            </select>
                            <select id="imageGenSubgroup">
                                <option value="">Select Subgroup</option>
                            </select>
                            <button class="nav-button" onclick="generateBulkImages()">Generate All Images</button>
                        </div>
                        <div id="generation-progress" style="margin: 20px 0;">
                            <!-- Progress will be shown here -->
                        </div>
                        <div id="generated-images">
                            <!-- Generated images will be shown here -->
                        </div>
                    </div>
                    
                    <div id="generated-images-view" style="display: none;">
                        <h3>Generated Images from Leonardo AI</h3>
                        <div style="margin-bottom: 20px;">
                            <button class="nav-button" onclick="checkFirebaseCollections()">Debug: Check Firebase Collections</button>
                            <button class="nav-button" onclick="document.getElementById('generated-images-list').innerHTML='<p>Simple test works</p>'">Simple Test</button>
                        </div>
                        <div id="generated-images-list">
                            <!-- Generated images will be loaded here -->
                        </div>
                    </div>
                    
                    <div id="answer-analytics" style="display: none;">
                        <h3>Answer Analytics</h3>
                        <div id="analytics-content">
                            <!-- Analytics will be loaded here -->
                        </div>
                    </div>
                </div>

                <div id="creators-section" style="display: none;">
                    <h2>Creator Management</h2>
                    <div style="display: flex; height: calc(100vh - 220px); gap: 20px;">
                        <div style="flex: 1; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
                            <iframe src="leftconsole_creators.html" style="width: 100%; height: 100%; border: none;"></iframe>
                        </div>
                        <div style="flex: 1; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
                            <iframe src="rightconsole_creators.html" style="width: 100%; height: 100%; border: none;"></iframe>
                        </div>
                    </div>
                </div>

                <div id="lucy-ai-section" style="display: none;">
                    <h2>Lucy AI Controls</h2>
                    <div style="border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; height: calc(100vh - 220px);">
                        <iframe src="lucy-controls.html" style="width: 100%; height: 100%; border: none;"></iframe>
                    </div>
                </div>

                <div id="settings-section" style="display: none;">
                    <h2>System Settings</h2>
                    <p>Configure global system settings.</p>
                </div>
            </div>
        </div>

        <!-- Portal Submenu -->
        <div id="submenu-container" class="submenu-container">
            <div id="portal-submenu" class="submenu">
                <h2>Portals <span class="close-button" onclick="closeSubmenu(this)">×</span></h2>
                <div class="portal-grid">
                    <a href="../../src/pages/dashboard.html" target="_parent" class="portal-button"><img src="../../public/assets/icons/portal_icon.png" alt="portals"><span>PORTALS</span></a>
                    <a href="../destiny/opening.html" target="_parent" class="portal-button"><img src="../../public/assets/icons/fave_icon.png" alt="destiny"><span>DESTINY</span></a>
                    <a href="../lifestyles/listingsconsole.html" target="_parent" class="portal-button"><img src="../../public/assets/icons/listing_icon.png" alt="listings"><span>LISTINGS</span></a>
                    <a href="../ai/ktgai.html" target="_parent" class="portal-button"><img src="../../public/assets/icons/ai_brain_logo_icon.png" alt="ktgai"><span>KTG.AI</span></a>
                    <a href="../music/ktgmusic.html" target="_parent" class="portal-button"><img src="../../public/assets/icons/qr_icon.png" alt="ktgmusic"><span>KTG.MUSIC</span></a>
                    <a href="../about/creator.html" target="_parent" class="portal-button"><img src="../../public/assets/icons/kgz_white_icon.png" alt="web3"><span>WEB3</span></a>
                    <a href="../about/creator.html" target="_parent" class="portal-button"><img src="../../public/assets/icons/vr_icon.png" alt="XR"><span>VR/AR/XR</span></a>
                    <a href="../games/dignbling.html" target="_parent" class="portal-button"><img src="../../public/assets/icons/diamond_mine_icon.png" alt="diamond"><span>DIGN BLING</span></a>
                    <a href="../games/4playchess.html" target="_parent" class="portal-button"><img src="../../public/assets/icons/chess_icon.png" alt="chess"><span>4 PLAY CHESS</span></a>
                    <a href="../about/creator.html" target="_parent" class="portal-button"><img src="../../public/assets/icons/tarot_icon.png" alt="tarot"><span>METAPHYSICS</span></a>
                    <a href="../about/creator.html" target="_parent" class="portal-button"><img src="../../public/assets/icons/globe_icon.png" alt="map"><span>MAP</span></a>
                </div>
            </div>
        </div>

        <!-- User Details Modal -->
        <div id="userModal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeUserModal()">&times;</span>
                <h3>User Details</h3>
                <div class="modal-field" style="text-align: center; margin-bottom: 20px;">
                    <img id="modalAvatar" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid var(--accent-color);" src="" alt="User Avatar">
                </div>
                <div class="modal-field">
                    <label>Avatar Name:</label>
                    <span id="modalAvatarName"></span>
                </div>
                <div class="modal-field">
                    <label>Email:</label>
                    <span id="modalEmail"></span>
                </div>
                <div class="modal-field">
                    <label>Role:</label>
                    <span id="modalRole"></span>
                </div>
                <div class="modal-field">
                    <label>Wallet ID:</label>
                    <span id="modalWalletId"></span>
                </div>
                <div class="modal-field">
                    <label>Tagline:</label>
                    <span id="modalTagline"></span>
                </div>
                <div class="modal-field">
                    <label>Status:</label>
                    <span id="modalStatus"></span>
                </div>
                <div class="modal-field">
                    <label>Account Type:</label>
                    <span id="modalAccountType"></span>
                </div>
            </div>
        </div>

        <!-- Question Edit Modal -->
        <div id="questionModal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeQuestionModal()">&times;</span>
                <h3>Edit Question</h3>
                <div class="modal-field">
                    <label>Question Text:</label>
                    <input type="text" id="editQuestionText" class="form-input">
                </div>
                <div class="modal-field">
                    <label>Options (comma separated):</label>
                    <input type="text" id="editQuestionOptions" class="form-input">
                </div>
                <div class="modal-field">
                    <label>Image URL:</label>
                    <input type="text" id="editQuestionImage" class="form-input">
                </div>
                <div class="modal-field">
                    <label>Image Link URL:</label>
                    <input type="text" id="editQuestionImageLink" class="form-input">
                </div>
                <div class="modal-field">
                    <label>Custom Prompt (optional):</label>
                    <input type="text" id="editCustomPrompt" class="form-input" placeholder="Enter custom prompt for image generation">
                </div>
                <div class="modal-field" id="imagePreview" style="display: none;">
                    <label>Image Preview:</label>
                    <img id="previewImage" style="max-width: 200px; height: auto; border-radius: 4px; cursor: pointer;" onclick="openImageLink()">
                </div>
                <div style="margin-top: 20px;">
                    <button class="nav-button" onclick="generateSingleImage()">Generate Image</button>
                    <button class="nav-button" onclick="saveQuestionEdit()">Save Changes</button>
                    <button class="nav-button" onclick="closeQuestionModal()" style="background-color: #6c757d;">Cancel</button>
                </div>
            </div>
        </div>

        <audio id="musicPlayer" src="../../public/assets/ktgmusic/audio/game_console_loading.mp3" loop></audio>
    </div>

    <script>
        let allUsers = [];
        let showAvatarNames = true;
        let sortDirection = {};
        
        function sortTable(columnIndex) {
            const isAscending = sortDirection[columnIndex] !== true;
            sortDirection[columnIndex] = isAscending;
            
            allUsers.sort((a, b) => {
                let aVal, bVal;
                
                switch(columnIndex) {
                    case 0: // Email
                        aVal = a.email;
                        bVal = b.email;
                        break;
                    case 1: // Destiny
                        aVal = a.avatar_count > 0 ? 1 : 0;
                        bVal = b.avatar_count > 0 ? 1 : 0;
                        break;
                    case 2: // Chess
                        aVal = a.chess_active ? 1 : 0;
                        bVal = b.chess_active ? 1 : 0;
                        break;
                    case 3: // Bling
                        aVal = a.bling_active ? 1 : 0;
                        bVal = b.bling_active ? 1 : 0;
                        break;
                    case 4: // Creator
                        aVal = a.is_creator ? 1 : 0;
                        bVal = b.is_creator ? 1 : 0;
                        break;
                    case 5: // Level
                        aVal = a.level || 1;
                        bVal = b.level || 1;
                        break;
                    case 6: // Date Joined
                        aVal = a.created_at ? new Date(a.created_at) : new Date(0);
                        bVal = b.created_at ? new Date(b.created_at) : new Date(0);
                        break;
                    case 7: // Creator Date
                        aVal = a.creator_date ? new Date(a.creator_date) : new Date(0);
                        bVal = b.creator_date ? new Date(b.creator_date) : new Date(0);
                        break;
                    case 8: // Last Level Up
                        aVal = a.last_level_up ? new Date(a.last_level_up) : new Date(0);
                        bVal = b.last_level_up ? new Date(b.last_level_up) : new Date(0);
                        break;
                }
                
                if (aVal < bVal) return isAscending ? -1 : 1;
                if (aVal > bVal) return isAscending ? 1 : -1;
                return 0;
            });
            
            renderUsers();
            applyFilters();
        }
        
        const participantProfiles = {};
        
        // No Firebase initialization needed

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const icon = document.getElementById('collapseIcon');
            
            sidebar.classList.toggle('collapsed');
            icon.textContent = sidebar.classList.contains('collapsed') ? '▶' : '◀';
        }

        function showSection(sectionName) {
            // Hide all sections
            const sections = document.querySelectorAll('[id$="-section"]');
            sections.forEach(section => section.style.display = 'none');
            
            // Show selected section
            document.getElementById(sectionName + '-section').style.display = 'block';
            
            // Update active menu item
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.menu-item').classList.add('active');
            
            // Load users if users section is selected
            if (sectionName === 'users' && allUsers.length === 0) {
                loadUsers();
            }
            
            // Load avatars if avatars section is selected
            if (sectionName === 'avatars') {
                loadAvatarsFromDB();
            }
            
            // Load JourneyBook data if journeybook section is selected
            if (sectionName === 'journeybook') {
                loadJourneyBookQuestions();
            }
        }

        async function loadUsers() {
            const tbody = document.getElementById('usersTableBody');
            
            // Temporary hardcoded data until API is fixed
            allUsers = [{
                id: 1,
                email: 'gamemaster@ktg.io',
                avatar_count: 4,
                is_creator: true,
                chess_active: false,
                bling_active: false,
                level: 1,
                created_at: new Date().toISOString(),
                creator_date: null,
                last_level_up: null
            }];
            
            renderUsers();
            document.getElementById('dashboardTotalUsersCount').textContent = allUsers.length;
        }

        function renderUsers() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';
            
            allUsers.forEach((user, index) => {
                const row = document.createElement('tr');
                
                const joinDate = user.created_at ? new Date(user.created_at).toLocaleDateString() : 'N/A';
                const creatorDate = user.creator_date ? new Date(user.creator_date).toLocaleDateString() : 'N/A';
                const lastLevelUp = user.last_level_up ? new Date(user.last_level_up).toLocaleDateString() : 'N/A';
                
                // Check if user has avatars to determine destiny activity
                const hasAvatars = user.avatar_count > 0;
                
                row.innerHTML = `
                    <td>${user.email}</td>
                    <td>${hasAvatars ? '✓' : '✗'}</td>
                    <td>${user.chess_active ? '✓' : '✗'}</td>
                    <td>${user.bling_active ? '✓' : '✗'}</td>
                    <td>${user.is_creator ? '✓' : '✗'}</td>
                    <td>${user.level || 1}</td>
                    <td>${joinDate}</td>
                    <td>${creatorDate}</td>
                    <td>${lastLevelUp}</td>
                `;
                
                row.onclick = () => openUserModal(user, null);
                tbody.appendChild(row);
            });
        }
        
        function applyFilters() {
            const columns = {
                destiny: document.getElementById('filterDestiny').checked,
                chess: document.getElementById('filterChess').checked,
                bling: document.getElementById('filterBling').checked,
                creator: document.getElementById('filterCreator').checked,
                level: document.getElementById('filterLevel').checked,
                dateJoined: document.getElementById('filterDateJoined').checked,
                creatorDate: document.getElementById('filterCreatorDate').checked,
                lastLevelUp: document.getElementById('filterLastLevelUp').checked
            };
            
            document.getElementById('destinyCol').style.display = columns.destiny ? '' : 'none';
            document.getElementById('chessCol').style.display = columns.chess ? '' : 'none';
            document.getElementById('blingCol').style.display = columns.bling ? '' : 'none';
            document.getElementById('creatorCol').style.display = columns.creator ? '' : 'none';
            document.getElementById('levelCol').style.display = columns.level ? '' : 'none';
            document.getElementById('dateJoinedCol').style.display = columns.dateJoined ? '' : 'none';
            document.getElementById('creatorDateCol').style.display = columns.creatorDate ? '' : 'none';
            document.getElementById('lastLevelUpCol').style.display = columns.lastLevelUp ? '' : 'none';
            
            // Update table body cells
            const rows = document.querySelectorAll('#usersTableBody tr');
            rows.forEach(row => {
                const cells = row.children;
                if (cells.length > 1) {
                    cells[1].style.display = columns.destiny ? '' : 'none';
                    cells[2].style.display = columns.chess ? '' : 'none';
                    cells[3].style.display = columns.bling ? '' : 'none';
                    cells[4].style.display = columns.creator ? '' : 'none';
                    cells[5].style.display = columns.level ? '' : 'none';
                    cells[6].style.display = columns.dateJoined ? '' : 'none';
                    cells[7].style.display = columns.creatorDate ? '' : 'none';
                    cells[8].style.display = columns.lastLevelUp ? '' : 'none';
                }
            });
        }

        let allAvatars = [];
        let groupByEmail = false;
        let newestFirst = true;
        
        async function loadAvatarsFromDB() {
            try {
                const response = await fetch('/api/users/avatars');
                if (response.ok) {
                    allAvatars = await response.json();
                } else {
                    console.error('Failed to load avatars from database');
                    allAvatars = [];
                }
            } catch (error) {
                console.error('Error loading avatars:', error);
                allAvatars = [];
            }
            renderAvatars();
        }
        
        function toggleGroupByEmail() {
            groupByEmail = document.getElementById('groupByEmail').checked;
            renderAvatars();
        }
        
        function toggleSortOrder() {
            newestFirst = document.getElementById('newestFirst').checked;
            renderAvatars();
        }
        
        function renderAvatars() {
            const grid = document.getElementById('avatarGrid');
            grid.innerHTML = '';
            
            if (allAvatars.length === 0) {
                grid.innerHTML = '<div class="loading-message">No avatars found</div>';
                return;
            }
            
            let sortedAvatars = [...allAvatars];
            
            // Sort by creation date
            sortedAvatars.sort((a, b) => {
                const dateA = new Date(a.created_at);
                const dateB = new Date(b.created_at);
                return newestFirst ? dateB - dateA : dateA - dateB;
            });
            
            if (groupByEmail) {
                const grouped = {};
                sortedAvatars.forEach(avatar => {
                    if (!grouped[avatar.email]) grouped[avatar.email] = [];
                    grouped[avatar.email].push(avatar);
                });
                
                Object.entries(grouped).forEach(([email, avatars]) => {
                    const groupHeader = document.createElement('div');
                    groupHeader.style.cssText = 'grid-column: 1 / -1; font-weight: bold; color: var(--accent-color); margin: 20px 0 10px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 5px;';
                    groupHeader.textContent = `${email} (${avatars.length} avatars)`;
                    grid.appendChild(groupHeader);
                    
                    avatars.forEach(avatar => createAvatarCard(avatar, grid));
                });
            } else {
                sortedAvatars.forEach(avatar => createAvatarCard(avatar, grid));
            }
        }
        
        function createAvatarCard(avatar, container) {
            const card = document.createElement('div');
            card.className = 'avatar-card';
            
            const createdDate = new Date(avatar.created_at).toLocaleDateString();
            const imageUrl = avatar.image_url || '';
            
            card.innerHTML = `
                <div class="avatar-thumbnail">
                    ${imageUrl ? `<img src="${imageUrl}" alt="${avatar.name}" onerror="this.parentElement.innerHTML='${avatar.name.substring(0, 2).toUpperCase()}'">` : avatar.name.substring(0, 2).toUpperCase()}
                </div>
                <div class="avatar-name">${avatar.name}</div>
                <div class="avatar-tagline">${avatar.tagline || 'No tagline'}</div>
                <div class="avatar-status" style="font-size: 10px;">${avatar.email}</div>
                <div style="font-size: 10px; color: var(--text-secondary); margin-top: 5px;">Created: ${createdDate}</div>
            `;
            
            card.onclick = () => {
                alert(`Avatar: ${avatar.name}\nEmail: ${avatar.email}\nTagline: ${avatar.tagline}\nCreated: ${createdDate}`);
            };
            
            container.appendChild(card);
        }

        async function openUserModal(user, profile) {
            const modal = document.getElementById('userModal');
            
            document.getElementById('modalAvatarName').textContent = user.email.split('@')[0];
            document.getElementById('modalEmail').textContent = user.email;
            document.getElementById('modalRole').textContent = user.email === 'gamemaster@ktg.io' ? 'Master Admin' : 'Player';
            document.getElementById('modalWalletId').textContent = user.id;
            document.getElementById('modalTagline').textContent = 'N/A';
            document.getElementById('modalStatus').textContent = 'Active';
            document.getElementById('modalAccountType').textContent = user.email === 'gamemaster@ktg.io' ? 'Master Admin' : 'Standard User';
            
            // Show initials as avatar
            const displayName = user.email.split('@')[0];
            const initials = displayName.substring(0, 2).toUpperCase();
            document.getElementById('modalAvatar').style.display = 'none';
            document.getElementById('modalAvatar').insertAdjacentHTML('afterend', `<div style="width: 120px; height: 120px; border-radius: 50%; background: var(--accent-color); display: flex; align-items: center; justify-content: center; color: white; font-size: 36px; font-weight: bold; margin: 0 auto;">${initials}</div>`);
            
            modal.style.display = 'block';
        }

        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
        }

        // Portal menu functions
        function openSubmenu(submenu) {
            const selectedSubmenu = document.getElementById(submenu + '-submenu');
            if (selectedSubmenu) {
                if (selectedSubmenu.style.display === 'block') {
                    selectedSubmenu.style.display = 'none';
                } else {
                    const submenus = document.querySelectorAll('.submenu');
                    submenus.forEach(menu => menu.style.display = 'none');
                    selectedSubmenu.style.display = 'block';
                }
            }
        }

        function closeSubmenu(closeButton) {
            const submenu = closeButton.closest('.submenu');
            submenu.style.display = 'none';
        }

        // Click outside to close submenu and modal
        document.addEventListener('click', function(event) {
            const submenus = document.querySelectorAll('.submenu');
            const portalButton = document.querySelector('.portal-button');
            const modal = document.getElementById('userModal');
            
            let clickedInsideSubmenu = false;
            submenus.forEach(submenu => {
                if (submenu.contains(event.target)) {
                    clickedInsideSubmenu = true;
                }
            });
            
            if (!clickedInsideSubmenu && !portalButton.contains(event.target)) {
                submenus.forEach(submenu => {
                    submenu.style.display = 'none';
                });
            }
            
            // Close modal if clicking outside
            if (event.target === modal) {
                closeUserModal();
            }
            
            // Close question modal if clicking outside
            const questionModal = document.getElementById('questionModal');
            if (event.target === questionModal) {
                closeQuestionModal();
            }
        });

        // Music controls
        const musicPlayer = document.getElementById('musicPlayer');
        const musicToggle = document.getElementById('musicToggle');

        function toggleMusic() {
            if (musicPlayer.paused) {
                musicPlayer.play();
            } else {
                musicPlayer.pause();
            }
        }

        musicToggle.addEventListener('click', toggleMusic);

        // Initialize theme
        function initializeTheme() {
            const savedTheme = localStorage.getItem('ktg-theme') || 'ktg';
            document.body.setAttribute('data-theme', savedTheme);
        }

        // Initialize music
        function initializeMusic() {
            const autoplayEnabled = localStorage.getItem('ktg-autoplay') === 'true';
            const volume = parseFloat(localStorage.getItem('ktg-volume')) || 0.5;
            
            if (musicPlayer) {
                musicPlayer.volume = volume;
                if (autoplayEnabled) {
                    musicPlayer.play().catch(e => console.log('Autoplay prevented'));
                }
            }
        }

        // JourneyBook Management Functions
        let currentJBSection = '';
        let currentJBSubgroup = '';
        let journeybookQuestions = {};
        
        async function loadJourneyBookQuestions() {
            try {
                // Try to load from Firebase first
                if (!firebase.apps || firebase.apps.length === 0) {
                    firebase.initializeApp({
                        apiKey: "AIzaSyDrgOGvn8NHuq3T_ODse8buij9KXg1WkzI",
                        authDomain: "ktgio-3k38n.firebaseapp.com",
                        projectId: "ktgio-3k38n",
                        storageBucket: "ktgio-3k38n.firebasestorage.app",
                        messagingSenderId: "416239278754",
                        appId: "1:416239278754:web:028cd9fd6f13a5a4ed95fb"
                    });
                }
                
                const db = firebase.firestore();
                const doc = await db.collection('JourneyBookQuestions').doc('questions').get();
                
                if (doc.exists && doc.data().questions) {
                    journeybookQuestions = doc.data().questions;
                    console.log('Loaded questions from Firebase');
                    return;
                }
                
                // Fallback to static file if Firebase doesn't have data
                const response = await fetch('../journeybook/questions-data.js');
                const text = await response.text();
                const match = text.match(/const JOURNEYBOOK_QUESTIONS = ({[\s\S]*});/);
                if (match) {
                    journeybookQuestions = eval('(' + match[1] + ')');
                    console.log('Loaded questions from static file');
                }
            } catch (error) {
                console.error('Error loading questions:', error);
            }
        }
        
        function showQuestionManager() {
            document.getElementById('question-manager').style.display = 'block';
            document.getElementById('image-generator').style.display = 'none';
            document.getElementById('answer-analytics').style.display = 'none';
            loadJourneyBookQuestions();
            
            // Auto-select first section to show questions immediately
            setTimeout(() => {
                const sectionSelect = document.getElementById('sectionSelect');
                if (sectionSelect.options.length > 1) {
                    sectionSelect.value = 'values';
                    loadSectionQuestions();
                }
            }, 100);
        }
        
        function showImageGenerator() {
            document.getElementById('question-manager').style.display = 'none';
            document.getElementById('image-generator').style.display = 'block';
            document.getElementById('answer-analytics').style.display = 'none';
            loadJourneyBookQuestions();
        }
        
        function showGeneratedImages() {
            document.getElementById('question-manager').style.display = 'none';
            document.getElementById('image-generator').style.display = 'none';
            document.getElementById('generated-images-view').style.display = 'block';
            document.getElementById('answer-analytics').style.display = 'none';
            loadGeneratedImages();
        }
        
        function showAnswerAnalytics() {
            document.getElementById('question-manager').style.display = 'none';
            document.getElementById('image-generator').style.display = 'none';
            document.getElementById('generated-images-view').style.display = 'none';
            document.getElementById('answer-analytics').style.display = 'block';
            loadAnswerAnalytics();
        }
        
        function loadSectionQuestions() {
            const section = document.getElementById('sectionSelect').value;
            const subgroupSelect = document.getElementById('subgroupSelect');
            
            subgroupSelect.innerHTML = '<option value="">Select Subgroup</option>';
            
            if (section && journeybookQuestions[section]) {
                Object.keys(journeybookQuestions[section]).forEach(subgroup => {
                    const option = document.createElement('option');
                    option.value = subgroup;
                    option.textContent = subgroup;
                    subgroupSelect.appendChild(option);
                });
                
                // Auto-select first subgroup and show questions
                if (Object.keys(journeybookQuestions[section]).length > 0) {
                    const firstSubgroup = Object.keys(journeybookQuestions[section])[0];
                    subgroupSelect.value = firstSubgroup;
                    currentJBSubgroup = firstSubgroup;
                    displayQuestions(journeybookQuestions[section][firstSubgroup]);
                }
            }
            
            currentJBSection = section;
        }
        
        async function loadSubgroupQuestions() {
            const subgroup = document.getElementById('subgroupSelect').value;
            currentJBSubgroup = subgroup;
            
            if (currentJBSection && subgroup && journeybookQuestions[currentJBSection][subgroup]) {
                // Load image generator if not loaded
                if (!window.JourneyBookImageGenerator) {
                    await loadScript('../journeybook/image-generator.js');
                }
                await displayQuestions(journeybookQuestions[currentJBSection][subgroup]);
            }
        }
        
        async function displayQuestions(questions) {
            const container = document.getElementById('questions-list');
            container.innerHTML = '';
            
            for (let index = 0; index < questions.length; index++) {
                const question = questions[index];
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-item';
                questionDiv.style.display = 'flex';
                questionDiv.style.alignItems = 'center';
                questionDiv.style.gap = '15px';
                
                // Check for generated image in Firebase
                let imageUrl = question.image;
                if (!imageUrl && window.JourneyBookImageGenerator) {
                    const questionKey = `${currentJBSection}_${currentJBSubgroup}_${question.question}`.replace(/[^a-zA-Z0-9_]/g, '_');
                    imageUrl = await window.JourneyBookImageGenerator.loadImageFromDatabase(questionKey);
                }
                
                const thumbnailHtml = imageUrl ? 
                    `<img src="${imageUrl}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; flex-shrink: 0;" onerror="this.style.display='none'">` : 
                    `<div style="width: 60px; height: 60px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 10px; color: var(--text-secondary);">No Image</div>`;
                
                questionDiv.innerHTML = `
                    ${thumbnailHtml}
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 5px 0;">${question.question}</h4>
                        <div class="question-options" style="font-size: 12px; color: var(--text-secondary);">
                            Options: ${question.options.length > 0 ? question.options.join(', ') : 'Text input'}
                        </div>
                    </div>
                    <div class="question-actions">
                        <button class="btn-small btn-edit" onclick="editQuestion(${index})">Edit</button>
                        <button class="btn-small btn-delete" onclick="deleteQuestion(${index})">Delete</button>
                    </div>
                `;
                container.appendChild(questionDiv);
            }
        }
        
        function addQuestion() {
            const questionText = document.getElementById('newQuestion').value;
            const optionsText = document.getElementById('newOptions').value;
            const imageUrl = document.getElementById('newImage').value;
            
            if (!questionText || !currentJBSection || !currentJBSubgroup) {
                alert('Please fill in question text and select section/subgroup');
                return;
            }
            
            const options = optionsText ? optionsText.split(',').map(opt => opt.trim()) : [];
            
            const newQuestion = {
                question: questionText,
                options: options,
                image: imageUrl || ''
            };
            
            if (!journeybookQuestions[currentJBSection]) {
                journeybookQuestions[currentJBSection] = {};
            }
            if (!journeybookQuestions[currentJBSection][currentJBSubgroup]) {
                journeybookQuestions[currentJBSection][currentJBSubgroup] = [];
            }
            
            journeybookQuestions[currentJBSection][currentJBSubgroup].push(newQuestion);
            saveQuestionsToFirebase();
            loadSubgroupQuestions();
            
            document.getElementById('newQuestion').value = '';
            document.getElementById('newOptions').value = '';
            document.getElementById('newImage').value = '';
        }
        
        let editingQuestionIndex = -1;
        
        function editQuestion(index) {
            editingQuestionIndex = index;
            const question = journeybookQuestions[currentJBSection][currentJBSubgroup][index];
            
            document.getElementById('editQuestionText').value = question.question;
            document.getElementById('editQuestionOptions').value = question.options.join(', ');
            document.getElementById('editQuestionImage').value = question.image || '';
            document.getElementById('editQuestionImageLink').value = question.imageLink || '';
            document.getElementById('editCustomPrompt').value = '';
            
            // Show image preview if image exists
            if (question.image) {
                document.getElementById('previewImage').src = question.image;
                document.getElementById('imagePreview').style.display = 'block';
            } else {
                document.getElementById('imagePreview').style.display = 'none';
            }
            
            document.getElementById('questionModal').style.display = 'block';
        }
        
        function closeQuestionModal() {
            document.getElementById('questionModal').style.display = 'none';
            editingQuestionIndex = -1;
        }
        
        async function generateSingleImage() {
            if (editingQuestionIndex === -1) return;
            
            const questionText = document.getElementById('editQuestionText').value;
            const customPrompt = document.getElementById('editCustomPrompt').value;
            
            try {
                // Load image generator if not loaded
                if (!window.JourneyBookImageGenerator) {
                    await loadScript('../journeybook/image-generator.js');
                }
                
                // Show loading state
                const generateBtn = event.target;
                const originalText = generateBtn.textContent;
                generateBtn.textContent = 'Generating...';
                generateBtn.disabled = true;
                
                let imageUrl;
                if (customPrompt) {
                    // Use custom prompt with Pollinations
                    const encodedPrompt = encodeURIComponent(customPrompt);
                    imageUrl = `https://image.pollinations.ai/prompt/${encodedPrompt}?width=768&height=512&seed=${Math.floor(Math.random() * 1000000)}`;
                } else {
                    // Use default generation
                    imageUrl = await window.JourneyBookImageGenerator.getOrGenerateImage(
                        questionText, currentJBSection, currentJBSubgroup
                    );
                }
                
                if (imageUrl) {
                    document.getElementById('editQuestionImage').value = imageUrl;
                    document.getElementById('previewImage').src = imageUrl;
                    document.getElementById('imagePreview').style.display = 'block';
                }
                
                generateBtn.textContent = originalText;
                generateBtn.disabled = false;
                
            } catch (error) {
                console.error('Error generating image:', error);
                alert('Error generating image: ' + error.message);
            }
        }
        
        function saveQuestionEdit() {
            if (editingQuestionIndex === -1) return;
            
            const question = journeybookQuestions[currentJBSection][currentJBSubgroup][editingQuestionIndex];
            question.question = document.getElementById('editQuestionText').value;
            question.options = document.getElementById('editQuestionOptions').value.split(',').map(opt => opt.trim()).filter(opt => opt);
            question.image = document.getElementById('editQuestionImage').value;
            question.imageLink = document.getElementById('editQuestionImageLink').value;
            
            saveQuestionsToFirebase();
            loadSubgroupQuestions();
            closeQuestionModal();
        }
        
        function openImageLink() {
            const imageLink = document.getElementById('editQuestionImageLink').value;
            if (imageLink) {
                window.open(imageLink, '_blank');
            }
        }
        
        function deleteQuestion(index) {
            if (confirm('Are you sure you want to delete this question?')) {
                journeybookQuestions[currentJBSection][currentJBSubgroup].splice(index, 1);
                saveQuestionsToFirebase();
                loadSubgroupQuestions();
            }
        }
        
        async function saveQuestionsToFirebase() {
            try {
                // Initialize Firebase if not already done
                if (!firebase.apps || firebase.apps.length === 0) {
                    firebase.initializeApp({
                        apiKey: "AIzaSyDrgOGvn8NHuq3T_ODse8buij9KXg1WkzI",
                        authDomain: "ktgio-3k38n.firebaseapp.com",
                        projectId: "ktgio-3k38n",
                        storageBucket: "ktgio-3k38n.firebasestorage.app",
                        messagingSenderId: "416239278754",
                        appId: "1:416239278754:web:028cd9fd6f13a5a4ed95fb"
                    });
                }
                
                const db = firebase.firestore();
                await db.collection('JourneyBookQuestions').doc('questions').set({
                    questions: journeybookQuestions,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('Questions saved successfully');
            } catch (error) {
                console.error('Error saving questions:', error);
                alert('Error saving questions: ' + error.message);
            }
        }
        
        async function loadAnswerAnalytics() {
            try {
                const db = firebase.firestore();
                const snapshot = await db.collection('JourneyBooks').get();
                
                let totalUsers = 0;
                let answeredQuestions = {};
                
                snapshot.forEach(doc => {
                    totalUsers++;
                    const answers = doc.data().answers || {};
                    
                    Object.keys(answers).forEach(questionKey => {
                        if (!answeredQuestions[questionKey]) {
                            answeredQuestions[questionKey] = 0;
                        }
                        answeredQuestions[questionKey]++;
                    });
                });
                
                const analyticsContent = document.getElementById('analytics-content');
                analyticsContent.innerHTML = `
                    <h4>Total Users with JourneyBooks: ${totalUsers}</h4>
                    <h4>Most Answered Questions:</h4>
                    <ul>
                        ${Object.entries(answeredQuestions)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 10)
                            .map(([question, count]) => `<li>${question}: ${count} answers</li>`)
                            .join('')}
                    </ul>
                `;
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }
        
        function loadImageGenSubgroups() {
            const section = document.getElementById('imageGenSection').value;
            const subgroupSelect = document.getElementById('imageGenSubgroup');
            
            subgroupSelect.innerHTML = '<option value="">Select Subgroup</option>';
            
            if (section && journeybookQuestions[section]) {
                Object.keys(journeybookQuestions[section]).forEach(subgroup => {
                    const option = document.createElement('option');
                    option.value = subgroup;
                    option.textContent = subgroup;
                    subgroupSelect.appendChild(option);
                });
            }
        }
        
        async function generateBulkImages() {
            const section = document.getElementById('imageGenSection').value;
            const subgroup = document.getElementById('imageGenSubgroup').value;
            
            if (!section) {
                alert('Please select a section');
                return;
            }
            
            const progressDiv = document.getElementById('generation-progress');
            const imagesDiv = document.getElementById('generated-images');
            
            progressDiv.innerHTML = '<p>Starting image generation...</p>';
            imagesDiv.innerHTML = '';
            
            try {
                // Load Leonardo AI service
                if (!window.JourneyBookImageGenerator) {
                    await loadScript('../journeybook/image-generator.js');
                    await loadScript('../../shared/js/leonardo-config.js');
                }
                
                const questions = subgroup ? 
                    journeybookQuestions[section][subgroup] : 
                    Object.values(journeybookQuestions[section]).flat();
                
                let completed = 0;
                const total = questions.length;
                
                for (const question of questions) {
                    try {
                        progressDiv.innerHTML = `<p>Generating image ${completed + 1} of ${total}: ${question.question}</p>`;
                        
                        const imageUrl = await window.JourneyBookImageGenerator.getOrGenerateImage(
                            question.question, section, question.subgroup || subgroup
                        );
                        
                        if (imageUrl) {
                            const imageDiv = document.createElement('div');
                            imageDiv.style.cssText = 'margin: 10px 0; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;';
                            imageDiv.innerHTML = `
                                <h4>${question.question}</h4>
                                <img src="${imageUrl}" alt="Generated image" style="max-width: 200px; height: auto; border-radius: 4px;">
                                <p style="font-size: 12px; color: var(--text-secondary);">Section: ${section} | Subgroup: ${question.subgroup || subgroup}</p>
                            `;
                            imagesDiv.appendChild(imageDiv);
                        }
                        
                        completed++;
                    } catch (error) {
                        console.error(`Error generating image for: ${question.question}`, error);
                    }
                    
                    // Small delay to avoid rate limiting
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                progressDiv.innerHTML = `<p style="color: green;">✓ Completed generating ${completed} images!</p>`;
                
            } catch (error) {
                progressDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }
        
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        async function loadGeneratedImages() {
            const container = document.getElementById('generated-images-list');
            container.innerHTML = '<p>Firebase removed from system - Generated images feature disabled</p>';
        }
        
        async function useGeneratedImage(docId, imageUrl, questionText) {
            // Find the question in current subgroup and update its image
            const questions = journeybookQuestions[currentJBSection][currentJBSubgroup];
            const questionIndex = questions.findIndex(q => q.question === questionText);
            
            if (questionIndex !== -1) {
                questions[questionIndex].image = imageUrl;
                await saveQuestionsToFirebase();
                
                // Check if delete checkbox is checked
                const deleteCheckbox = document.getElementById(`deleteOnUse-${docId}`);
                if (deleteCheckbox && deleteCheckbox.checked) {
                    await deleteGeneratedImageSilent(docId);
                }
                
                await loadSubgroupQuestions();
                alert('Image updated for question: ' + questionText);
            } else {
                alert('Question not found in current subgroup');
            }
        }
        
        async function deleteGeneratedImage(docId) {
            if (!confirm('Are you sure you want to delete this generated image?')) {
                return;
            }
            await deleteGeneratedImageSilent(docId);
        }
        
        async function deleteGeneratedImageSilent(docId) {
            try {
                // Initialize Firebase if not already done
                if (!firebase.apps || firebase.apps.length === 0) {
                    firebase.initializeApp({
                        apiKey: "AIzaSyDrgOGvn8NHuq3T_ODse8buij9KXg1WkzI",
                        authDomain: "ktgio-3k38n.firebaseapp.com",
                        projectId: "ktgio-3k38n",
                        storageBucket: "ktgio-3k38n.firebasestorage.app",
                        messagingSenderId: "416239278754",
                        appId: "1:416239278754:web:028cd9fd6f13a5a4ed95fb"
                    });
                }
                
                const db = firebase.firestore();
                await db.collection('JourneyBookImages').doc(docId).delete();
                
                // Remove from UI
                const imageElement = document.getElementById(`image-${docId}`);
                if (imageElement) {
                    imageElement.remove();
                }
                
                console.log('Image deleted:', docId);
            } catch (error) {
                console.error('Error deleting image:', error);
                alert('Error deleting image: ' + error.message);
            }
        }
        
        async function checkFirebaseCollections() {
            const container = document.getElementById('generated-images-list');
            container.innerHTML = '<p>Firebase removed from system - Debug feature disabled</p>';
        }
        
        async function testLeonardoAPI() {
            const container = document.getElementById('generated-images-list');
            container.innerHTML = '<p>Testing Leonardo API...</p>';
            
            try {
                // Load Leonardo config
                if (!window.LEONARDO_CONFIG) {
                    await loadScript('../../shared/js/leonardo-config.js');
                }
                
                if (!window.JourneyBookImageGenerator) {
                    await loadScript('../journeybook/image-generator.js');
                }
                
                const apiKey = window.LEONARDO_CONFIG?.API_KEY;
                container.innerHTML = `
                    <h4>Leonardo API Test:</h4>
                    <p>API Key: ${apiKey ? 'Present' : 'Missing'}</p>
                    <p>Image Generator: ${window.JourneyBookImageGenerator ? 'Loaded' : 'Not Loaded'}</p>
                    <p>Check browser console (F12) for more details</p>
                `;
                
                console.log('Leonardo Config:', window.LEONARDO_CONFIG);
                console.log('Image Generator:', window.JourneyBookImageGenerator);
                
            } catch (error) {
                container.innerHTML = '<p style="color: red;">Error: ' + error.message + '</p>';
                console.error('Leonardo test error:', error);
            }
        }
        
        async function generateAndSaveAllImages() {
            if (!currentJBSection || !currentJBSubgroup) {
                alert('Please select a section and subgroup first');
                return;
            }
            
            const questions = journeybookQuestions[currentJBSection][currentJBSubgroup];
            if (!questions || questions.length === 0) {
                alert('No questions found in selected subgroup');
                return;
            }
            
            let generated = 0;
            for (const question of questions) {
                try {
                    const pageNumber = `${currentJBSection}_${currentJBSubgroup}_${question.question}`.replace(/\s+/g, '_').toLowerCase();
                    const prompt = `${question.question} - journeybook page illustration`;
                    
                    const imageUrl = await generateImageForQuestion(prompt);
                    
                    if (imageUrl) {
                        await fetch('/api/users/journeybook/image', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                avatarId: 0,
                                pageNumber: pageNumber,
                                imageUrl: imageUrl,
                                prompt: prompt
                            })
                        });
                        
                        generated++;
                        console.log(`Generated and saved image for: ${question.question}`);
                    }
                } catch (error) {
                    console.error(`Error generating image for ${question.question}:`, error);
                }
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            alert(`Generated and saved ${generated} images to database`);
            await loadSubgroupQuestions();
        }
        
        async function generateAndSaveAllImagesForSection() {
            if (!currentJBSection) {
                alert('Please select a section first');
                return;
            }
            
            const sectionQuestions = journeybookQuestions[currentJBSection];
            if (!sectionQuestions) {
                alert('No questions found in selected section');
                return;
            }
            
            let totalGenerated = 0;
            
            for (const [subgroup, questions] of Object.entries(sectionQuestions)) {
                for (const question of questions) {
                    try {
                        const pageNumber = `${currentJBSection}_${subgroup}_${question.question}`.replace(/\s+/g, '_').toLowerCase();
                        const prompt = `${question.question} - journeybook page illustration`;
                        
                        const imageUrl = await generateImageForQuestion(prompt);
                        
                        if (imageUrl) {
                            await fetch('/api/users/journeybook/image', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({
                                    avatarId: 0,
                                    pageNumber: pageNumber,
                                    imageUrl: imageUrl,
                                    prompt: prompt
                                })
                            });
                            
                            totalGenerated++;
                            console.log(`Generated image for: ${question.question}`);
                        }
                    } catch (error) {
                        console.error(`Error generating image for ${question.question}:`, error);
                    }
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            alert(`Generated and saved ${totalGenerated} images for entire ${currentJBSection} section`);
        }
        
        async function generateImageForQuestion(prompt) {
            try {
                if (window.LEONARDO_CONFIG?.API_KEY) {
                    const response = await fetch('https://cloud.leonardo.ai/api/rest/v1/generations', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${window.LEONARDO_CONFIG.API_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            prompt: prompt,
                            modelId: window.LEONARDO_CONFIG.MODEL_ID,
                            width: 768,
                            height: 512,
                            num_images: 1
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.sdGenerationJob?.generationId) {
                            const imageUrl = await pollLeonardoGeneration(data.sdGenerationJob.generationId);
                            if (imageUrl) return imageUrl;
                        }
                    }
                }
                
                const encodedPrompt = encodeURIComponent(prompt);
                return `https://image.pollinations.ai/prompt/${encodedPrompt}?width=768&height=512&seed=${Math.floor(Math.random() * 1000000)}`;
                
            } catch (error) {
                console.error('Error generating image:', error);
                const encodedPrompt = encodeURIComponent(prompt);
                return `https://image.pollinations.ai/prompt/${encodedPrompt}?width=768&height=512&seed=${Math.floor(Math.random() * 1000000)}`;
            }
        }
        
        async function pollLeonardoGeneration(generationId) {
            for (let i = 0; i < 30; i++) {
                try {
                    const response = await fetch(`https://cloud.leonardo.ai/api/rest/v1/generations/${generationId}`, {
                        headers: {
                            'Authorization': `Bearer ${window.LEONARDO_CONFIG.API_KEY}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.generations_by_pk?.status === 'COMPLETE' && data.generations_by_pk.generated_images?.length > 0) {
                            return data.generations_by_pk.generated_images[0].url;
                        }
                    }
                } catch (error) {
                    console.error('Error polling Leonardo:', error);
                }
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
            return null;
        }
        
        function exportQuestions() {
            const dataStr = JSON.stringify(journeybookQuestions, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'journeybook-questions.json';
            link.click();
        }
        
        async function pushImagesToDatabase() {
            if (!currentJBSection || !currentJBSubgroup) {
                alert('Please select a section and subgroup first');
                return;
            }
            
            const questions = journeybookQuestions[currentJBSection][currentJBSubgroup];
            if (!questions || questions.length === 0) {
                alert('No questions found in selected subgroup');
                return;
            }
            
            let pushed = 0;
            for (const question of questions) {
                if (question.image) {
                    try {
                        const pageNumber = `${currentJBSection}_${currentJBSubgroup}_${question.question}`.replace(/[^a-zA-Z0-9_]/g, '_').toLowerCase();
                        
                        // Convert relative path to absolute URL
                        let imageUrl = question.image;
                        if (imageUrl.startsWith('../../')) {
                            imageUrl = window.location.origin + '/' + imageUrl.replace('../../', '');
                        }
                        
                        const response = await fetch('/api/users/journeybook/page', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                section: currentJBSection,
                                subgroup: currentJBSubgroup,
                                question: question.question,
                                options: question.options || [],
                                imageUrl: imageUrl,
                                pageNumber: pageNumber
                            })
                        });
                        
                        if (response.ok) {
                            pushed++;
                            console.log(`Pushed page for: ${question.question}`);
                        } else {
                            console.error(`Failed to push page for ${question.question}:`, await response.text());
                        }
                    } catch (error) {
                        console.error(`Error pushing page for ${question.question}:`, error);
                    }
                }
            }
            
            alert(`Successfully pushed ${pushed} pages to database for ${currentJBSection}/${currentJBSubgroup}`);
        }
        
        async function clearAllTestUsers() {
            if (!confirm('Are you sure you want to delete ALL test users? This action cannot be undone.')) {
                return;
            }
            
            try {
                const db = firebase.firestore();
                
                // Get all users with @ktg.test emails
                const usersSnapshot = await db.collection('Users').where('email', '>=', '@ktg.test').where('email', '<=', '@ktg.test\uf8ff').get();
                const walletSnapshot = await db.collection('Wallet').where('email', '>=', '@ktg.test').where('email', '<=', '@ktg.test\uf8ff').get();
                
                let deletedCount = 0;
                
                // Delete from Users collection
                const userBatch = db.batch();
                usersSnapshot.forEach(doc => {
                    userBatch.delete(doc.ref);
                    deletedCount++;
                });
                await userBatch.commit();
                
                // Delete from Wallet collection
                const walletBatch = db.batch();
                walletSnapshot.forEach(doc => {
                    walletBatch.delete(doc.ref);
                });
                await walletBatch.commit();
                
                alert(`Successfully deleted ${deletedCount} test users from Firebase`);
                
                // Refresh the users list
                allUsers = [];
                await loadUsers();
                
            } catch (error) {
                console.error('Error deleting test users:', error);
                alert('Error deleting test users: ' + error.message);
            }
        }
        
        // Token Distribution Functions
        async function distributeTokensToUser() {
            const email = document.getElementById('tokenTargetEmail').value;
            const tokens = {
                life_1: parseInt(document.getElementById('tokens1Life').value) || 0,
                life_3: parseInt(document.getElementById('tokens3Life').value) || 0,
                life_6: parseInt(document.getElementById('tokens6Life').value) || 0,
                life_9: parseInt(document.getElementById('tokens9Life').value) || 0,
                diamond: parseInt(document.getElementById('tokensDiamond').value) || 0
            };
            
            if (!email) {
                alert('Please enter a target email');
                return;
            }
            
            try {
                const db = firebase.firestore();
                
                // Find user by email
                const userQuery = await db.collection('Users').where('email', '==', email).get();
                if (userQuery.empty) {
                    alert('User not found with email: ' + email);
                    return;
                }
                
                const userId = userQuery.docs[0].id;
                const walletRef = db.collection('Wallet').doc(userId);
                
                // Check if wallet exists, create if not
                const walletDoc = await walletRef.get();
                if (!walletDoc.exists) {
                    await walletRef.set({
                        connected_email: email,
                        wallet_id: userId,
                        created_at: firebase.firestore.FieldValue.serverTimestamp(),
                        expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
                        life_1: 0,
                        life_3: 0,
                        life_6: 0,
                        life_9: 0,
                        diamond: 0
                    });
                }
                
                // Add tokens
                await walletRef.update({
                    life_1: firebase.firestore.FieldValue.increment(tokens.life_1),
                    life_3: firebase.firestore.FieldValue.increment(tokens.life_3),
                    life_6: firebase.firestore.FieldValue.increment(tokens.life_6),
                    life_9: firebase.firestore.FieldValue.increment(tokens.life_9),
                    diamond: firebase.firestore.FieldValue.increment(tokens.diamond)
                });
                
                alert(`Tokens distributed successfully to ${email}!`);
                
            } catch (error) {
                console.error('Error distributing tokens:', error);
                alert('Error distributing tokens: ' + error.message);
            }
        }
        
        async function distributeToAllTestUsers() {
            const tokens = {
                life_1: parseInt(document.getElementById('tokens1Life').value) || 0,
                life_3: parseInt(document.getElementById('tokens3Life').value) || 0,
                life_6: parseInt(document.getElementById('tokens6Life').value) || 0,
                life_9: parseInt(document.getElementById('tokens9Life').value) || 0,
                diamond: parseInt(document.getElementById('tokensDiamond').value) || 0
            };
            
            if (!confirm(`Distribute tokens to ALL registered users?\n1-Life: ${tokens.life_1}\n3-Life: ${tokens.life_3}\n6-Life: ${tokens.life_6}\n9-Life: ${tokens.life_9}\nDiamond: ${tokens.diamond}`)) {
                return;
            }
            
            try {
                const db = firebase.firestore();
                const usersSnapshot = await db.collection('Users').get();
                
                let distributed = 0;
                for (const userDoc of usersSnapshot.docs) {
                    const userData = userDoc.data();
                    const userId = userDoc.id;
                    
                    try {
                        const walletRef = db.collection('Wallet').doc(userId);
                        
                        // Check if wallet exists, create if not
                        const walletDoc = await walletRef.get();
                        if (!walletDoc.exists) {
                            await walletRef.set({
                                connected_email: userData.email,
                                wallet_id: userId,
                                created_at: firebase.firestore.FieldValue.serverTimestamp(),
                                expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
                                life_1: 0,
                                life_3: 0,
                                life_6: 0,
                                life_9: 0,
                                diamond: 0
                            });
                        }
                        
                        // Add tokens
                        await walletRef.update({
                            life_1: firebase.firestore.FieldValue.increment(tokens.life_1),
                            life_3: firebase.firestore.FieldValue.increment(tokens.life_3),
                            life_6: firebase.firestore.FieldValue.increment(tokens.life_6),
                            life_9: firebase.firestore.FieldValue.increment(tokens.life_9),
                            diamond: firebase.firestore.FieldValue.increment(tokens.diamond)
                        });
                        
                        distributed++;
                    } catch (error) {
                        console.error(`Error distributing to ${userData.email}:`, error);
                    }
                }
                
                alert(`Tokens distributed to ${distributed} users!`);
                
            } catch (error) {
                console.error('Error in bulk distribution:', error);
                alert('Error in bulk distribution: ' + error.message);
            }
        }
        
        async function viewAllWallets() {
            const container = document.getElementById('walletsList');
            container.innerHTML = '<p>Loading wallets...</p>';
            
            try {
                const db = firebase.firestore();
                const walletsSnapshot = await db.collection('Wallet').get();
                
                if (walletsSnapshot.empty) {
                    container.innerHTML = '<p>No wallets found.</p>';
                    return;
                }
                
                let html = '<table class="users-table"><thead><tr><th>Email</th><th>1-Life</th><th>3-Life</th><th>6-Life</th><th>9-Life</th><th>Diamond</th><th>Expires</th></tr></thead><tbody>';
                
                walletsSnapshot.forEach(doc => {
                    const wallet = doc.data();
                    const expiresDate = wallet.expires_at ? new Date(wallet.expires_at.toDate()).toLocaleDateString() : 'N/A';
                    
                    html += `
                        <tr>
                            <td>${wallet.connected_email || 'N/A'}</td>
                            <td>${wallet.life_1 || 0}</td>
                            <td>${wallet.life_3 || 0}</td>
                            <td>${wallet.life_6 || 0}</td>
                            <td>${wallet.life_9 || 0}</td>
                            <td>${wallet.diamond || 0}</td>
                            <td>${expiresDate}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading wallets:', error);
                container.innerHTML = '<p style="color: red;">Error loading wallets: ' + error.message + '</p>';
            }
        }
        
        async function resetAllWallets() {
            if (!confirm('Are you sure you want to RESET ALL WALLETS? This will set all token counts to 0!')) {
                return;
            }
            
            try {
                const db = firebase.firestore();
                const walletsSnapshot = await db.collection('Wallet').get();
                
                const batch = db.batch();
                walletsSnapshot.forEach(doc => {
                    batch.update(doc.ref, {
                        life_1: 0,
                        life_3: 0,
                        life_6: 0,
                        life_9: 0,
                        diamond: 0
                    });
                });
                
                await batch.commit();
                alert(`Reset ${walletsSnapshot.size} wallets to 0 tokens`);
                
                // Refresh wallet view if visible
                if (document.getElementById('walletsList').innerHTML.includes('table')) {
                    viewAllWallets();
                }
                
            } catch (error) {
                console.error('Error resetting wallets:', error);
                alert('Error resetting wallets: ' + error.message);
            }
        }

        window.addEventListener('load', async () => {
            initializeTheme();
            initializeMusic();
            
            try {
                await loadScript('../../shared/js/leonardo-config.js');
            } catch (error) {
                console.log('Leonardo config not loaded:', error);
            }
            
            document.getElementById('editQuestionImage').addEventListener('input', function() {
                const imageUrl = this.value;
                if (imageUrl) {
                    document.getElementById('previewImage').src = imageUrl;
                    document.getElementById('imagePreview').style.display = 'block';
                } else {
                    document.getElementById('imagePreview').style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>