<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KTG Admin Dashboard</title>
    <link rel="stylesheet" href="../../shared/styles/global.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; background: #111; color: #fff; }
        .admin-container { display: flex; gap: 20px; }
        .left-panel { flex: 1; }
        .right-panel { width: 300px; }
        .users-table { width: 100%; border-collapse: collapse; background: #222; }
        .users-table th { background: #2f27c8; color: white; padding: 12px; text-align: left; }
        .users-table td { padding: 12px; border-bottom: 1px solid #444; }
        .users-table tr:hover { background: #333; }
        .toggle-container { margin: 20px 0; }
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; background: #28a745; color: white; }
    </style>
</head>
<body>
    <h1>KTG Admin Dashboard</h1>
    
    <div class="toggle-container">
        <label>
            <input type="checkbox" id="avatarToggle" onchange="toggleAvatarView()">
            Show Avatar Names
        </label>
    </div>
    
    <div class="admin-container">
        <div class="left-panel">
            <h2>Users</h2>
            <table class="users-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Wallet ID</th>
                        <th>Tagline</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr><td colspan="6">Loading users...</td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="right-panel">
            <h3>Stats</h3>
            <p>Total Users: <span id="totalUsersCount">16</span></p>
        </div>
    </div>

    <script>
        console.log('Admin dashboard loaded');
        
        let allUsers = [];
        let showAvatarNames = false;
        
        const participantProfiles = {
            'mei@ktg.test': { name: 'Mei', tagline: 'Vixen Seeks Hero' },
            'astral.maiden@ktg.test': { name: 'Astral Maiden', tagline: 'Seeker Seeks Starfarer' },
            'cyber.shaman@ktg.test': { name: 'Cyber Shaman', tagline: 'Oracle Seeks Glitchrunner' },
            'crimson.oracle@ktg.test': { name: 'Crimson Oracle', tagline: 'Seer Seeks Renegade' },
            'ethereal.sentinel@ktg.test': { name: 'Ethereal Sentinel', tagline: 'Guardian Seeks Wanderer' },
            'steel.ronin@ktg.test': { name: 'Steel Ronin', tagline: 'Ronin Seeks Master' },
            'desert.dancer@ktg.test': { name: 'Desert Dancer', tagline: 'Dancer Seeks Guide' },
            'echo.twins@ktg.test': { name: 'Echo Twins', tagline: 'Twins Seek Unity' },
            'skull.prophet@ktg.test': { name: 'Skull Prophet', tagline: 'Prophet Seeks Disciple' },
            'neon.nomad@ktg.test': { name: 'Neon Nomad', tagline: 'Nomad Seeks Sanctuary' },
            'inferno.queen@ktg.test': { name: 'Inferno Queen', tagline: 'Queen Seeks Rebel' },
            'golden.muse@ktg.test': { name: 'Golden Muse', tagline: 'Muse Seeks Inspiration' },
            'blood.rose@ktg.test': { name: 'Blood Rose', tagline: 'Rose Seeks Thorn' },
            'seraphic.siren@ktg.test': { name: 'Seraphic Siren', tagline: 'Siren Seeks Sailor' },
            'cyber.geisha@ktg.test': { name: 'Cyber Geisha', tagline: 'Geisha Seeks Patron' },
            'pixel.priestess@ktg.test': { name: 'Pixel Priestess', tagline: 'Priestess Seeks Convert' }
        };

        async function loadUsers() {
            console.log('Loading users...');
            const tbody = document.getElementById('usersTableBody');
            
            try {
                firebase.initializeApp({
                    apiKey: "AIzaSyDrgOGvn8NHuq3T_ODse8buij9KXg1WkzI",
                    authDomain: "ktgio-3k38n.firebaseapp.com",
                    projectId: "ktgio-3k38n",
                    storageBucket: "ktgio-3k38n.firebasestorage.app",
                    messagingSenderId: "416239278754",
                    appId: "1:416239278754:web:028cd9fd6f13a5a4ed95fb"
                });
                
                const db = firebase.firestore();
                const usersSnapshot = await db.collection('Users').get();
                console.log(`Found ${usersSnapshot.size} users`);
                
                // Group by email
                const usersByEmail = {};
                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    if (user.email && !usersByEmail[user.email]) {
                        usersByEmail[user.email] = { id: doc.id, ...user };
                    }
                });
                
                allUsers = Object.values(usersByEmail);
                renderUsers();
                
                document.getElementById('totalUsersCount').textContent = allUsers.length;
                console.log('Users loaded successfully');
                
            } catch (error) {
                console.error('Error:', error);
                tbody.innerHTML = `<tr><td colspan="6">Error: ${error.message}</td></tr>`;
            }
        }

        function renderUsers() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';
            
            allUsers.forEach(user => {
                const profile = participantProfiles[user.email];
                const row = document.createElement('tr');
                
                let displayName, tagline;
                if (showAvatarNames && profile) {
                    displayName = profile.name;
                    tagline = profile.tagline;
                } else {
                    displayName = user.email.split('@')[0];
                    tagline = 'N/A';
                }
                
                row.innerHTML = `
                    <td>${displayName}</td>
                    <td>${user.email}</td>
                    <td>Player</td>
                    <td>${user.id}</td>
                    <td>${tagline}</td>
                    <td><span class="status-badge">Active</span></td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function toggleAvatarView() {
            showAvatarNames = document.getElementById('avatarToggle').checked;
            renderUsers();
        }

        // Load users when page loads
        setTimeout(loadUsers, 1000);
    </script>
</body>
</html>