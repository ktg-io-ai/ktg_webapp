<style>
    .popup-header {
        background-color: var(--accent-color);
        color: white;
        padding: 15px 20px;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: bold;
    }
    
    .close-btn {
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .close-btn:hover {
        background-color: rgba(255,255,255,0.2);
    }
    
    .chat-area {
        height: 300px;
        overflow-y: auto;
        padding: 15px;
        background-color: var(--bg-primary);
        border-bottom: 1px solid var(--border-color);
    }
    
    .message {
        padding: 8px 12px;
        margin-bottom: 8px;
        border-radius: 10px;
        max-width: 70%;
        word-break: break-word;
    }
    
    .user-message {
        background-color: var(--accent-color);
        color: white;
        margin-left: auto;
        text-align: right;
    }
    
    .received-message {
        background-color: var(--bg-secondary);
        color: var(--text-primary);
        margin-right: auto;
    }
    
    .chat-input-area {
        padding: 15px;
        display: flex;
        gap: 10px;
        align-items: center;
        position: relative;
    }
    
    .plus-btn {
        background-color: var(--accent-color);
        color: white;
        border: none;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .plus-btn:hover {
        background-color: var(--accent-hover);
    }
    
    .upload-popup {
        position: absolute;
        bottom: 50px;
        left: 0;
        background-color: var(--bg-secondary);
        border: 2px solid var(--accent-color);
        border-radius: 8px;
        padding: 10px;
        display: none;
        flex-direction: column;
        gap: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .upload-option {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .upload-option:hover {
        background-color: var(--hover-bg);
    }
    
    .upload-option img {
        width: 20px;
        height: 20px;
    }
    
    .chat-input {
        flex: 1;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background-color: var(--bg-primary);
        color: var(--text-primary);
    }
    
    .action-btn {
        background-color: var(--accent-color);
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.2s ease;
    }
    
    .action-btn:hover {
        background-color: var(--accent-hover);
        transform: translateY(-1px);
    }
</style>

<div class="popup-header">
    <span data-translate="destiny.gameconsole.chat">Chat</span>
    <button class="close-btn" onclick="closeCurrentPopup()">Ã—</button>
</div>

<div class="chat-area" id="chatArea">
    <!-- Chat messages will be loaded here -->
</div>

<div class="chat-input-area">
    <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleFileUpload(event, 'image')">
    <input type="file" id="videoInput" accept="video/*" style="display: none;" onchange="handleFileUpload(event, 'video')">
    <input type="file" id="audioInput" accept="audio/*" style="display: none;" onchange="handleFileUpload(event, 'audio')">
    
    <button class="plus-btn" onclick="toggleUploadPopup()" title="Add Media">+</button>
    
    <div id="uploadPopup" class="upload-popup">
        <div class="upload-option" onclick="document.getElementById('imageInput').click(); hideUploadPopup();">
            <img src="../../public/assets/icons/new_image_icon.png" alt="Image" class="theme-icon" data-ktg="../../public/assets/icons/new_image_icon.png" data-light="../../public/assets/icons/new_image_icon-blk.png" data-dark="../../public/assets/icons/new_image_icon-wht.png">
            <span>Image</span>
        </div>
        <div class="upload-option" onclick="document.getElementById('videoInput').click(); hideUploadPopup();">
            <img src="../../public/assets/icons/new_video_icon.png" alt="Video" class="theme-icon" data-ktg="../../public/assets/icons/new_video_icon.png" data-light="../../public/assets/icons/new_video_icon-blk.png" data-dark="../../public/assets/icons/new_video_icon-wht.png">
            <span>Video</span>
        </div>
        <div class="upload-option" onclick="document.getElementById('audioInput').click(); hideUploadPopup();">
            <img src="../../public/assets/icons/new_audio_icon.png" alt="Audio" class="theme-icon" data-ktg="../../public/assets/icons/new_audio_icon.png" data-light="../../public/assets/icons/new_audio_icon-blk.png" data-dark="../../public/assets/icons/new_audio_icon-wht.png">
            <span>Audio</span>
        </div>
    </div>
    
    <input type="text" class="chat-input" id="messageInput" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendMessage()">
    <button class="action-btn" onclick="sendMessage()">Send</button>
</div>

<script>
    function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        
        if (message) {
            addMessageToChat(message, 'user-message');
            input.value = '';
            
            // Record interaction
            window.parent.postMessage({
                type: 'recordInteraction',
                interactionType: 'chat',
                data: { message: message, message_type: 'text', timestamp: new Date().toISOString() },
                targetAvatarId: window.parent.selectedAvatarId
            }, '*');
        }
    }
    
    function toggleUploadPopup() {
        const popup = document.getElementById('uploadPopup');
        popup.style.display = popup.style.display === 'flex' ? 'none' : 'flex';
    }
    
    function hideUploadPopup() {
        document.getElementById('uploadPopup').style.display = 'none';
    }
    
    async function handleFileUpload(event, mediaType) {
        const file = event.target.files[0];
        if (!file) return;
        
        // Check file size (5MB limit)
        if (file.size > 5 * 1024 * 1024) {
            alert('File too large. Maximum size is 5MB.');
            event.target.value = '';
            return;
        }
        
        try {
            let processedFile = file;
            
            // Compress file based on type
            if (mediaType === 'image') {
                processedFile = await compressImage(file);
            } else if (mediaType === 'video') {
                // For videos, just check size - compression would be too complex for frontend
                if (file.size > 3 * 1024 * 1024) {
                    alert('Video too large. Maximum size is 3MB.');
                    event.target.value = '';
                    return;
                }
            }
            
            // Upload file to server
            const formData = new FormData();
            formData.append('file', processedFile);
            
            const response = await fetch('/api/chat/upload', {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                const result = await response.json();
                
                // Add file message to chat
                addFileMessageToChat(file.name, mediaType, result.file.url);
                
                // Record interaction with file
                window.parent.postMessage({
                    type: 'recordInteraction',
                    interactionType: 'chat',
                    data: { 
                        message: `Shared ${mediaType}: ${file.name}`,
                        message_type: mediaType,
                        attachment_url: result.file.url,
                        file_name: file.name,
                        file_size: processedFile.size,
                        timestamp: new Date().toISOString() 
                    },
                    targetAvatarId: window.parent.selectedAvatarId
                }, '*');
            } else {
                console.error('Upload failed:', response.statusText);
                alert('Upload failed. Please try again.');
            }
        } catch (error) {
            console.error('Upload error:', error);
            alert('Upload failed. Please try again.');
        }
        
        // Reset file input
        event.target.value = '';
    }
    
    function compressImage(file) {
        return new Promise((resolve) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                // Calculate new dimensions (max 800px width/height)
                let { width, height } = img;
                const maxSize = 800;
                
                if (width > height && width > maxSize) {
                    height = (height * maxSize) / width;
                    width = maxSize;
                } else if (height > maxSize) {
                    width = (width * maxSize) / height;
                    height = maxSize;
                }
                
                canvas.width = width;
                canvas.height = height;
                
                // Draw and compress
                ctx.drawImage(img, 0, 0, width, height);
                canvas.toBlob(resolve, 'image/jpeg', 0.8);
            };
            
            img.src = URL.createObjectURL(file);
        });
    }
    
    function addMessageToChat(message, className) {
        const chatArea = document.getElementById('chatArea');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${className}`;
        messageDiv.textContent = message;
        chatArea.appendChild(messageDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
    }
    
    function addFileMessageToChat(fileName, fileType, fileUrl) {
        const chatArea = document.getElementById('chatArea');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message user-message';
        
        if (fileType === 'image') {
            messageDiv.innerHTML = `<img src="${fileUrl}" alt="${fileName}" style="max-width: 200px; border-radius: 8px;">`;
        } else if (fileType === 'video') {
            messageDiv.innerHTML = `<video controls style="max-width: 200px; border-radius: 8px;"><source src="${fileUrl}"></video>`;
        } else if (fileType === 'audio') {
            messageDiv.innerHTML = `<audio controls><source src="${fileUrl}"></audio>`;
        } else {
            messageDiv.innerHTML = `ðŸ“Ž ${fileName}`;
        }
        
        chatArea.appendChild(messageDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
    }
    
    function closeCurrentPopup() {
        const overlay = document.getElementById('chat-popup-overlay');
        if (overlay && overlay.parentNode) {
            overlay.parentNode.removeChild(overlay);
        }
    }
    
    // Load chat history when popup opens
    async function loadChatHistory() {
        try {
            const currentAvatarId = window.parent.currentAvatarId;
            const targetAvatarId = window.parent.selectedAvatarId;
            
            if (!currentAvatarId || !targetAvatarId) return;
            
            const response = await fetch(`/api/chat/history/${currentAvatarId}/${targetAvatarId}`);
            if (response.ok) {
                const messages = await response.json();
                displayChatHistory(messages);
            }
        } catch (error) {
            console.error('Error loading chat history:', error);
        }
    }
    
    function displayChatHistory(messages) {
        const chatArea = document.getElementById('chatArea');
        chatArea.innerHTML = '';
        
        messages.forEach(msg => {
            const isFromCurrentUser = msg.sender_avatar_id == window.parent.currentAvatarId;
            const messageClass = isFromCurrentUser ? 'user-message' : 'received-message';
            
            if (msg.attachment_url) {
                addFileMessageToChat(msg.file_name || 'File', msg.message_type, msg.attachment_url, messageClass);
            } else {
                addMessageToChat(msg.message_text, messageClass);
            }
        });
    }
    
    function addMessageToChat(message, className) {
        const chatArea = document.getElementById('chatArea');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${className}`;
        messageDiv.textContent = message;
        chatArea.appendChild(messageDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
    }
    
    function addFileMessageToChat(fileName, fileType, fileUrl, className = 'user-message') {
        const chatArea = document.getElementById('chatArea');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${className}`;
        
        if (fileType === 'image') {
            messageDiv.innerHTML = `<img src="${fileUrl}" alt="${fileName}" style="max-width: 200px; border-radius: 8px;">`;
        } else if (fileType === 'video') {
            messageDiv.innerHTML = `<video controls style="max-width: 200px; border-radius: 8px;"><source src="${fileUrl}"></video>`;
        } else if (fileType === 'audio') {
            messageDiv.innerHTML = `<audio controls><source src="${fileUrl}"></audio>`;
        } else {
            messageDiv.innerHTML = `ðŸ“Ž ${fileName}`;
        }
        
        chatArea.appendChild(messageDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
    }
    
    // Load chat history when popup opens
    document.addEventListener('DOMContentLoaded', loadChatHistory);
    
    // Close upload popup when clicking outside
    document.addEventListener('click', function(event) {
        const popup = document.getElementById('uploadPopup');
        const plusBtn = event.target.closest('.plus-btn');
        if (!plusBtn && !popup.contains(event.target)) {
            hideUploadPopup();
        }
    });
</script>