<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang="music.title">KTG Mobile Music Player</title>
    <link rel="stylesheet" href="m_music_player.css">
    <link rel="stylesheet" href="../../../shared/styles/global.css">
    <script src="../../../shared/js/language.js"></script>
    <script src="../../../shared/js/theme-icons.js"></script>
</head>
<body>
    <div class="container">
        <div class="right-column">
            <div>
                <div class="dropdown-wrapper">
                    <select id="music-source" class="music-source" title="Music Source"></select>
                    <div class="top-controls">
                        <button id="share-button" onclick="openShareModal()">Share</button>
                        <span id="close-button" title="Close">X</span>
                    </div>
                </div>
                <br>
                <div class="album-art">
                    <img id="album-art-img" src="https://placehold.co/150x150/1a1a1a/fff?text=KTG" alt="Album Art">
                </div>
            </div>
            
            <div class="song-info">
                <div id="song-title" class="song-title">Select a playlist</div>
                <div id="artist-name" class="artist-name">to begin</div>
            </div>
            
            <div class="share-count">
                <span id="share-count-text">Shares: <span id="share-count-number">0</span></span>
            </div>
            
            <br><br>

            <div id="progress-container">
                <div id="progress-bar"></div>
            </div>
            <br>

            <div class="controls">
                <button id="prev-btn"><img src="../../../public/assets/icons/prev_play_icon.png" alt="Previous"></button>
                <button id="continuous-btn"><img src="../../../public/assets/icons/continuous_play_icon.png" alt="Continuous"></button>
                <button id="play-pause-btn"><img src="../../../public/assets/icons/play_pause.png" alt="Play/Pause"></button>
                <button id="shuffle-btn"><img src="../../../public/assets/icons/shuffle_play_icon.png" alt="Shuffle"></button>
                <button id="next-btn"><img src="../../../public/assets/icons/next_play_icon.png" alt="Next"></button>
            </div>
            <br>

            <a href="https://www.karmathegame.org" class="karmathegame-button">KTG.IO COMING SOON</a>
        </div>
    </div>
    
    <!-- Share Modal -->
    <div id="share-modal" class="share-modal">
        <div class="share-modal-content">
            <h3>Share This Song</h3>
            <div class="share-options">
                <button class="share-option" onclick="shareToSocial('facebook')">
                    <img src="../../../public/assets/icons/facebook_icon.png" alt="Facebook">
                </button>
                <button class="share-option" onclick="shareToSocial('twitter')">
                    <img src="../../../public/assets/icons/twitter_icon.png" alt="Twitter">
                </button>
                <button class="share-option" onclick="shareToSocial('instagram')">
                    <img class="instagram-icon" src="../../../public/assets/icons/instagram_icon.png" alt="Instagram">
                </button>
                <button class="share-option" onclick="shareToSocial('linkedin')">
                    <img class="linkedin-icon" src="../../../public/assets/icons/linkedin_icon.png" alt="LinkedIn">
                </button>
                <button class="share-option" onclick="shareToSocial('discord')">
                    <img class="discord-icon" src="../../../public/assets/icons/discord_icon.png" alt="Discord">
                </button>
                <button class="share-option" onclick="shareToSocial('telegram')">
                    <img class="telegram-icon" src="../../../public/assets/icons/telegram_icon.png" alt="Telegram">
                </button>
            </div>
            <button class="close-modal" onclick="closeShareModal()">Close</button>
        </div>
    </div>
    
    <audio id="audio-player"></audio>

    <script>
        // DOM Elements
        const audioPlayer = document.getElementById('audio-player');
        const albumArtImg = document.getElementById('album-art-img');
        const songTitleEl = document.getElementById('song-title');
        const artistNameEl = document.getElementById('artist-name');
        const musicSourceSelect = document.getElementById('music-source');
        const progressBar = document.getElementById('progress-bar');
        const progressContainer = document.getElementById('progress-container');
        const shareCountEl = document.getElementById('share-count-number');

        // Control Buttons
        const prevBtn = document.getElementById('prev-btn');
        const continuousBtn = document.getElementById('continuous-btn');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const shuffleBtn = document.getElementById('shuffle-btn');
        const nextBtn = document.getElementById('next-btn');
        
        // Player State
        let allSongsData = {};
        let originalPlaylist = [];
        let currentPlaylist = [];
        let currentSongIndex = 0;
        let isShuffled = false;
        let isContinuous = false;
        let currentSong = null;
        let shareCount = 0;

        // Initialize theme and language
        function initializeTheme() {
            const savedTheme = localStorage.getItem('ktg-theme') || 'ktg';
            document.body.setAttribute('data-theme', savedTheme);
            
            if (typeof updateThemeIcons === 'function') {
                updateThemeIcons(savedTheme);
            }
        }

        // Share functionality
        function openShareModal() {
            document.getElementById('share-modal').style.display = 'flex';
        }

        function closeShareModal() {
            document.getElementById('share-modal').style.display = 'none';
        }

        function shareToSocial(platform) {
            if (!currentSong) return;
            
            const shareUrl = generateShareUrl(currentSong);
            const shareText = `Check out "${currentSong.title}" by ${currentSong.artist || 'KTG Music'} on KTG.MUSIC!`;
            
            let url = '';
            switch(platform) {
                case 'facebook':
                    url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`;
                    break;
                case 'twitter':
                    url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareUrl)}`;
                    break;
                case 'linkedin':
                    url = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(shareUrl)}`;
                    break;
                case 'instagram':
                case 'discord':
                case 'telegram':
                    // Copy to clipboard for platforms without direct share URLs
                    navigator.clipboard.writeText(`${shareText} ${shareUrl}`);
                    alert('Share link copied to clipboard!');
                    break;
            }
            
            if (url) {
                window.open(url, '_blank', 'width=600,height=400');
            }
            
            // Increment share count
            incrementShareCount();
            closeShareModal();
        }

        function generateShareUrl(song) {
            const baseUrl = window.location.origin + window.location.pathname;
            return `${baseUrl}?song=${encodeURIComponent(song.title)}&playlist=${encodeURIComponent(musicSourceSelect.value)}`;
        }

        function incrementShareCount() {
            shareCount++;
            shareCountEl.textContent = shareCount;
            
            // Store share count in localStorage
            if (currentSong) {
                const shareKey = `share_${currentSong.title.replace(/\s+/g, '_')}`;
                localStorage.setItem(shareKey, shareCount.toString());
            }
        }

        function loadShareCount(song) {
            if (song) {
                const shareKey = `share_${song.title.replace(/\s+/g, '_')}`;
                shareCount = parseInt(localStorage.getItem(shareKey) || '0');
                shareCountEl.textContent = shareCount;
            }
        }

        // Initialize player
        async function initializePlayer() {
            try {
                const [ktgMusicResponse, soundtrackResponse, vrWorldsResponse] = await Promise.all([
                    fetch('../../../data/songs.json'),
                    fetch('../../../data/soundtrack.json'),
                    fetch('../../../data/vrworlds.json')
                ]);

                if (!ktgMusicResponse.ok || !soundtrackResponse.ok || !vrWorldsResponse.ok) {
                    throw new Error('Network response was not ok for one or more files.');
                }

                const ktgMusic = await ktgMusicResponse.json();
                const soundtrack = await soundtrackResponse.json();
                const vrWorlds = await vrWorldsResponse.json();

                allSongsData = {
                    "KTG AI Music": ktgMusic,
                    "Original Soundtrack": soundtrack,
                    "VR Worlds": vrWorlds
                };
                
                populateDropdown();
                
                // Check for shared song in URL
                const urlParams = new URLSearchParams(window.location.search);
                const sharedSong = urlParams.get('song');
                const sharedPlaylist = urlParams.get('playlist');
                
                if (sharedSong && sharedPlaylist && allSongsData[sharedPlaylist]) {
                    loadPlaylist(sharedPlaylist);
                    const songIndex = currentPlaylist.findIndex(song => song.title === sharedSong);
                    if (songIndex !== -1) {
                        currentSongIndex = songIndex;
                        loadSong(currentSongIndex);
                    }
                } else {
                    loadPlaylist(Object.keys(allSongsData)[0]);
                }

            } catch (error) {
                console.error('Failed to load songs:', error);
                songTitleEl.textContent = 'Error loading music';
                artistNameEl.textContent = 'Please check file paths and JSON format.';
            }
        }

        function populateDropdown() {
            musicSourceSelect.innerHTML = '';
            for (const category in allSongsData) {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                musicSourceSelect.appendChild(option);
            }
        }
        
        function loadPlaylist(categoryName) {
            originalPlaylist = allSongsData[categoryName];
            currentPlaylist = [...originalPlaylist];
            currentSongIndex = 0;
            isShuffled = false;
            shuffleBtn.classList.remove('active');
            loadSong(currentSongIndex);
            pauseSong();
        }

        function loadSong(index) {
            if (!currentPlaylist || currentPlaylist.length === 0) return;
            const song = currentPlaylist[index];
            currentSong = song;
            audioPlayer.src = song.mp3;
            albumArtImg.src = song.cover;
            albumArtImg.onerror = () => {
                albumArtImg.src = 'https://placehold.co/150x150/1a1a1a/fff?text=KTG';
            };
            songTitleEl.textContent = song.title;
            artistNameEl.textContent = song.artist || "";
            loadShareCount(song);
        }

        // Control Functions
        function playSong() {
            audioPlayer.play();
        }

        function pauseSong() {
            audioPlayer.pause();
        }

        function playNextSong() {
            currentSongIndex = (currentSongIndex + 1) % currentPlaylist.length;
            loadSong(currentSongIndex);
            playSong();
        }

        function playPrevSong() {
            currentSongIndex = (currentSongIndex - 1 + currentPlaylist.length) % currentPlaylist.length;
            loadSong(currentSongIndex);
            playSong();
        }

        function toggleShuffle() {
            isShuffled = !isShuffled;
            shuffleBtn.classList.toggle('active', isShuffled);
            
            if (isShuffled) {
                shuffleCurrentPlaylist();
            } else {
                const currentSong = currentPlaylist[currentSongIndex];
                currentPlaylist = [...originalPlaylist];
                currentSongIndex = currentPlaylist.findIndex(song => song.title === currentSong.title);
            }
        }

        function shuffleCurrentPlaylist() {
            for (let i = currentPlaylist.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [currentPlaylist[i], currentPlaylist[j]] = [currentPlaylist[j], currentPlaylist[i]];
            }
            currentSongIndex = 0;
        }

        function toggleContinuous() {
            isContinuous = !isContinuous;
            continuousBtn.classList.toggle('active', isContinuous);
        }

        // Event Listeners
        playPauseBtn.addEventListener('click', () => {
            if (audioPlayer.paused) {
                playSong();
            } else {
                pauseSong();
            }
        });

        nextBtn.addEventListener('click', playNextSong);
        prevBtn.addEventListener('click', playPrevSong);
        shuffleBtn.addEventListener('click', toggleShuffle);
        continuousBtn.addEventListener('click', toggleContinuous);

        musicSourceSelect.addEventListener('change', (e) => {
            loadPlaylist(e.target.value);
        });

        audioPlayer.addEventListener('ended', () => {
            if (isContinuous) {
                playNextSong();
            } else {
                pauseSong();
            }
        });

        audioPlayer.addEventListener('timeupdate', () => {
            const { currentTime, duration } = audioPlayer;
            if (duration) {
                const progressPercent = (currentTime / duration) * 100;
                progressBar.style.width = `${progressPercent}%`;
            }
        });

        progressContainer.addEventListener('click', (e) => {
            const width = progressContainer.clientWidth;
            const clickX = e.offsetX;
            const duration = audioPlayer.duration;
            if (duration) {
                audioPlayer.currentTime = (clickX / width) * duration;
            }
        });

        document.getElementById('close-button').addEventListener('click', () => {
            window.close();
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
            
            if (typeof langManager !== 'undefined') {
                const savedLanguage = localStorage.getItem('ktg-language') || 'en';
                langManager.setLanguage(savedLanguage);
                langManager.updateUI();
            }
            
            initializePlayer();
        });
    </script>
</body>
</html>