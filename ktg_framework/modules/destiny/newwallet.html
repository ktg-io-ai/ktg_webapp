<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang="destiny.newwallet.title">Register New Wallet - Karma the Game</title>
    <link rel="stylesheet" href="../../shared/styles/global.css">
    <script src="../../shared/js/language.js"></script>
    <script src="../../shared/js/wallet-manager.js"></script>
    <script src="../../shared/js/firebase-config.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            overflow-y: auto;
        }

        /* Top Bar */
        .top-bar {
            background-color: var(--topbar-bg);
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 22px;
            z-index: 999;
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        [data-theme="ktg"] .top-bar {
            border-bottom: none;
            box-shadow: none;
        }

        [data-theme="dark"] .top-bar {
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .top-bar h1 {
            margin: 0;
            font-size: 16px;
            color: var(--text-primary);
            font-weight: 600;
        }

        .top-bar .song-title {
            margin-left: 20px;
            padding-right: 50px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
        }

        #musicToggle {
            background: none;
            border: none;
            cursor: pointer;
            margin-right: 10px;
            vertical-align: middle;
        }

        #musicToggle img {
            width: 24px;
            height: 24px;
        }

        .music-buttons {
            margin-right: 10px;
        }

        /* Main content container */
        .main-content {
            margin-top: 50px;
            min-height: calc(100vh - 50px);
            padding: 20px;
        }

        .wallet-form {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            background: var(--bg-secondary);
            border-radius: 20px;
            text-align: center;
        }

        .wallet-form h2 {
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 10px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 16px;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .submit-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 20px;
        }

        .submit-btn:hover {
            background: var(--accent-hover);
        }

        .submit-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .back-link {
            display: block;
            color: var(--text-secondary);
            text-decoration: none;
            margin-top: 20px;
        }

        .back-link:hover {
            color: var(--accent-color);
        }

        .error-message {
            color: #ff4444;
            margin-top: 10px;
            font-size: 14px;
        }

        .success-message {
            color: #44ff44;
            margin-top: 10px;
            font-size: 14px;
        }

        .google-signin {
            margin: 20px 0;
            text-align: center;
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--text-secondary);
        }

        .divider span {
            padding: 0 15px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Theme Variables */
        :root {
            --bg-primary: #111;
            --bg-secondary: rgba(1, 1, 1, 0.9);
            --text-primary: #fff;
            --text-secondary: #ccc;
            --border-color: #2f27c8;
            --hover-bg: #222;
            --topbar-bg: #111;
            --accent-color: #2f27c8;
            --accent-hover: #1e1a8a;
        }

        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: rgba(248, 249, 250, 0.9);
            --text-primary: #1a1a1a;
            --text-secondary: #6c757d;
            --border-color: #e9ecef;
            --hover-bg: #f1f3f4;
            --topbar-bg: #ffffff;
            --accent-color: #2f27c8;
            --accent-hover: #1e1a8a;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: rgba(45, 45, 45, 0.9);
            --text-primary: #f5f5dc;
            --text-secondary: #b8b8b8;
            --border-color: #404040;
            --hover-bg: #3a3a3a;
            --topbar-bg: #2d2d2d;
            --accent-color: #2f27c8;
            --accent-hover: #1e1a8a;
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="music-buttons">
            <button onclick="window.open('../music/mobile/m_music_player.html', '_blank', 'width=500,height=950')" style="background: none; border: none; cursor: pointer;">
                <img src="../../public/assets/icons/music_player_icon.png" alt="Open Music Player" style="width: 24px; height: 24px;">
            </button>
        </div>
        <h1 data-lang="destiny.title">Karma the Game of Destiny</h1>
        <div class="song-title">
            <button id="musicToggle">
                <img src="../../public/assets/icons/play_pause.png" alt="Music Toggle">
            </button>
            <span data-lang="music.playing">PLAYING</span>: <span id="currentSongTitle">Register Loading</span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="wallet-form">
        <h2 data-lang="destiny.newwallet.register_title">REGISTER NEW WALLET</h2>
        
        <form id="walletForm">
            <div class="form-group">
                <label for="email" data-lang="destiny.newwallet.email_placeholder">EMAIL ADDRESS</label>
                <input type="email" id="email" name="email" required>
            </div>
            
            <div class="form-group">
                <label for="password" data-lang="destiny.newwallet.password_placeholder">PASSWORD</label>
                <input type="password" id="password" name="password" required>
            </div>
            
            <div class="form-group">
                <label for="confirmPassword" data-lang="destiny.newwallet.password_again_placeholder">PASSWORD AGAIN</label>
                <input type="password" id="confirmPassword" name="confirmPassword" required>
            </div>
            
            <button type="submit" class="submit-btn" data-lang="destiny.newwallet.next">NEXT</button>
            
            <div id="message" class="error-message" style="display: none;"></div>
        </form>
        
        <div class="divider">
            <span>OR</span>
        </div>
        
        <div class="google-signin">
            <button type="button" class="submit-btn" onclick="handleGoogleSignIn()" style="background: #4285f4; margin-top: 0;">
                Sign up with Google
            </button>
        </div>
        
        <a href="opening.html" class="back-link">‚Üê Back to Opening</a>
        
        <div style="margin-top: 30px; padding: 20px; background: var(--bg-primary); border-radius: 10px; text-align: left;">
            <h4 style="color: var(--text-primary); margin-top: 0;">About Your Wallet</h4>
            <p style="color: var(--text-secondary); font-size: 14px;">
                Your wallet is your permanent identity on the KTG platform. Once created, you can:
            </p>
            <ul style="color: var(--text-secondary); font-size: 14px;">
                <li>Play Destiny with life tokens (1-9 lives, $1.99-$9.99)</li>
                <li>Play 4-Player Chess with AI opponents ($1.99 per AI)</li>
                <li>Access all KTG portals and features</li>
                <li>Store Tokens Indefinitely until used for Destiny or 4 Play or other Experiences requiring a Token</li>
                <li>Tokens do NOT Expire. Lives only Last 30 Days or until terminated by other players during gaming</li>
                <li>Link crypto wallet for payments and NFT minting</li>
            </ul>
        </div>
    </div>
    </div>

    <script>
        // Initialize theme and language
        function initializeTheme() {
            const savedTheme = localStorage.getItem('ktg-theme') || 'ktg';
            document.body.setAttribute('data-theme', savedTheme);
        }

        // Handle form submission
        document.getElementById('walletForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const messageDiv = document.getElementById('message');
            const submitBtn = document.querySelector('.submit-btn');
            
            // Clear previous messages
            messageDiv.style.display = 'none';
            
            // Validate passwords match
            if (password !== confirmPassword) {
                showMessage('Passwords do not match', 'error');
                return;
            }
            
            // Validate password strength
            if (password.length < 6) {
                showMessage('Password must be at least 6 characters long', 'error');
                return;
            }
            
            // Disable submit button
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating Wallet...';
            
            try {
                // Create wallet with Firebase
                const response = await fetch('/api/wallet/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Store user data
                    const userData = {
                        email: email,
                        walletId: result.walletId,
                        createdAt: Date.now()
                    };
                    
                    localStorage.setItem('ktg_user', JSON.stringify(userData));
                    
                    // Initialize wallet manager
                    window.walletManager.email = email;
                    window.walletManager.walletId = result.walletId;
                    
                    // Add starter tokens (optional)
                    await window.walletManager.addToken('1life', 1);
                    await window.walletManager.addToken('3life', 1);
                    
                    showMessage('Wallet created successfully! Redirecting...', 'success');
                    
                    // Redirect to avatar creation after success
                    setTimeout(() => {
                        window.location.href = 'newavatar.html';
                    }, 2000);
                    
                } else {
                    showMessage(result.message || 'Failed to create wallet', 'error');
                }
                
            } catch (error) {
                console.error('Wallet creation error:', error);
                showMessage('Network error. Please try again.', 'error');
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = 'NEXT';
            }
        });
        
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
            messageDiv.style.display = 'block';
        }

        // Google Sign-In with Firebase
        async function handleGoogleSignIn() {
            try {
                // Wait for Firebase to initialize
                if (!window.KTGFirebase.initialized) {
                    await window.KTGFirebase.init();
                }
                
                // Create Firebase user with Google provider
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await firebase.auth().signInWithPopup(provider);
                
                const userData = {
                    email: result.user.email,
                    name: result.user.displayName,
                    picture: result.user.photoURL,
                    walletId: result.user.uid,
                    createdAt: Date.now(),
                    provider: 'google',
                    firebaseUid: result.user.uid
                };
                
                localStorage.setItem('ktg_user', JSON.stringify(userData));
                
                // Initialize wallet manager
                window.walletManager.email = userData.email;
                window.walletManager.walletId = userData.walletId;
                
                // Add starter tokens
                await window.walletManager.addToken('1life', 1);
                await window.walletManager.addToken('3life', 1);
                
                showMessage('Google sign-in successful! Redirecting...', 'success');
                
                setTimeout(() => {
                    window.location.href = 'newavatar.html';
                }, 2000);
                
            } catch (error) {
                console.error('Google sign-in error:', error);
                showMessage('Google sign-in failed: ' + error.message, 'error');
            }
        }

        // Music player functionality
        const musicPlayer = document.createElement('audio');
        musicPlayer.src = '../../public/assets/ktgmusic/audio/register_loading.mp3';
        musicPlayer.loop = true;
        musicPlayer.volume = 0.5;
        document.body.appendChild(musicPlayer);

        function toggleMusic() {
            if (musicPlayer.paused) {
                musicPlayer.play();
            } else {
                musicPlayer.pause();
            }
        }

        document.getElementById('musicToggle').addEventListener('click', toggleMusic);
        
        // Initialize on load
        window.addEventListener('load', () => {
            initializeTheme();
            
            if (typeof langManager !== 'undefined') {
                const savedLanguage = localStorage.getItem('ktg-language') || 'en';
                langManager.setLanguage(savedLanguage);
                langManager.updateUI();
            }
        });
    </script>
</body>
</html>